<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>C√°psula Volver al Futuro 2.0 ‚Äî Pro</title>
  <meta name="theme-color" content="#0ea5e9">
  <meta name="description" content="C√°psulas cifradas con nave espacial: crea, comparte y √°brelas en la fecha. Pago Pro con Stripe.">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tipograf√≠as -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

  <!-- Librer√≠as externas -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>

  <style>
    :root{
      --c1:#0ea5e9; --c2:#a78bfa; --fg:#e5e7eb; --mut:#94a3b8;
      --glass:#ffffff10; --glassB:#ffffff18; --bgh:#0b1220; --bg2:#0f172a;
      --accent:#22d3ee;
    }
    [data-theme="light"]{
      --fg:#0f172a; --mut:#475569; --glass:#0000000d; --glassB:#0000001a; --bgh:#eef2ff; --bg2:#f8fafc;
      --accent:#0ea5e9;
    }
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg);
      background: radial-gradient(120vmax 80vmax at 15% 10%, #0b1325 0%, var(--bgh) 40%, var(--bg2) 100%);
      overflow-x:hidden;
    }
    .brand{font-family:Orbitron,Inter,sans-serif;letter-spacing:.3px}
    .glass{background:linear-gradient(180deg,var(--glass),transparent);border:1px solid var(--glassB);backdrop-filter:blur(12px); border-radius:18px; box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .btn{border:1px solid var(--glassB); padding:.7rem 1rem; border-radius:12px; font-weight:700; transition:.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(90deg,var(--c1),var(--c2)); color:#0b1220}
    .btn-ghost{background:rgba(255,255,255,.06)}
    .tab-btn{padding:.6rem 1rem;border-radius:999px;border:1px solid var(--glassB)}
    .active-tab{background:linear-gradient(90deg,var(--c1),var(--c2)); color:#0b1220}
    .input,.textarea,select{width:100%; background:rgba(255,255,255,.05); border:1px solid var(--glassB); color:var(--fg); border-radius:12px; padding:.85rem}
    .label{font-size:.85rem;color:var(--mut);font-weight:600}

    /* ========= NAVE ESPACIAL ========= */
    .nave{
      width:240px; height:240px; margin:0 auto; position:relative; overflow:visible;
      filter:drop-shadow(0 12px 28px rgba(14,165,233,.25));
      transition: transform 1.2s ease, opacity .6s ease;
    }
    .rocket{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:120px; height:180px;
    }
    .rocket .body{
      position:absolute; left:50%; transform:translateX(-50%);
      width:80px; height:120px; top:20px;
      background:linear-gradient(180deg,#e2e8f0,#94a3b8);
      border-radius:40px 40px 20px 20px;
      border:1px solid rgba(255,255,255,.3);
    }
    .rocket .window{
      position:absolute; left:50%; transform:translateX(-50%);
      top:48px; width:30px; height:30px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #7dd3fc, #0ea5e9);
      border:2px solid #bae6fd;
      box-shadow:0 0 12px #07b6d4;
    }
    .rocket .nose{
      position:absolute; left:50%; transform:translateX(-50%);
      top:-6px; width:0; height:0;
      border-left:40px solid transparent;
      border-right:40px solid transparent;
      border-bottom:30px solid #cbd5e1;
      filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));
    }
    .rocket .fin{
      position:absolute; width:34px; height:40px; bottom:36px; background:linear-gradient(180deg,#8b5cf6,#22d3ee);
      border:1px solid rgba(255,255,255,.35);
    }
    .rocket .fin.left{ left:8px; border-radius:10px 0 10px 14px; transform:skewY(8deg) }
    .rocket .fin.right{ right:8px; border-radius:0 10px 14px 10px; transform:skewY(-8deg) }
    .flame{
      position:absolute; left:50%; transform:translateX(-50%); bottom:-10px;
      width:20px; height:28px; border-radius:50% 50% 50% 50%;
      background:radial-gradient(circle at 50% 20%, #fde047, #f97316 60%, #ef4444 90%);
      filter:blur(0.4px);
      animation:flame 0.14s infinite alternate;
      box-shadow:0 0 12px #fb923c;
    }
    @keyframes flame{ from{ transform:translateX(-50%) scaleY(1) } to{ transform:translateX(-50%) scaleY(1.25) } }

    /* Estela/warp */
    .warp{
      position:absolute; left:50%; transform:translateX(-50%); bottom:-40px;
      width:4px; height:60px; background:linear-gradient(180deg, rgba(34,211,238,.9), transparent);
      filter:blur(1px); opacity:.9; animation:warp 1.2s linear infinite;
    }
    .warp:before,.warp:after{
      content:""; position:absolute; left:-8px; width:20px; height:20px; top:-12px;
      background:radial-gradient(circle, rgba(34,211,238,.35), transparent 60%);
      filter:blur(4px);
    }
    @keyframes warp{ from{ height:40px; opacity:.8 } to{ height:100px; opacity:.3 } }

    /* Estados */
    .nave.launch { transform: translateY(-260px) scale(.88) rotate(-2deg); opacity:0; }
    .hidden{display:none}

    /* Modal contenido */
    .open-content{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="sticky top-0 backdrop-blur border-b border-white/10" style="background:linear-gradient(180deg,rgba(11,18,32,.85),transparent)">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="w-10 h-10 rounded-full bg-gradient-to-r from-cyan-400 to-indigo-500 grid place-items-center">üöÄ</span>
        <a href="#" class="brand text-xl md:text-2xl font-extrabold">C√°psula <span class="text-cyan-300">Volver</span> <span class="text-indigo-300">al Futuro</span></a>
        <span id="proBadge" class="hidden ml-3 text-xs px-2 py-1 rounded-full bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">PRO</span>
      </div>
      <div class="flex items-center gap-2">
        <select id="themeSel" class="input !py-2 !px-3 w-auto">
          <option value="dark">Oscuro</option>
          <option value="light">Claro</option>
          <option value="auto">Auto</option>
        </select>
        <a class="btn btn-ghost" id="btnGoPro">‚≠ê Pro</a>
        <a class="btn btn-primary" href="#crear">Crear</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto p-4 md:p-8 grid md:grid-cols-2 gap-6">
    <div class="glass p-6">
      <div class="brand text-3xl font-extrabold mb-2">Guarda hoy. Descubre ma√±ana.</div>
      <p class="text-slate-300">C√°psulas cifradas con <b>AES-256-GCM</b>, link/QR/WhatsApp/Telegram/Email y adjuntos. Todo en tu navegador.</p>
      <div class="mt-4 flex gap-3">
        <a href="#crear" class="btn btn-primary">Crear c√°psula</a>
        <a href="#mis" class="btn btn-ghost">Mis c√°psulas</a>
      </div>
    </div>
    <div class="glass p-6 text-center">
      <!-- NAVE HERO -->
      <div id="naveHero" class="nave mb-6">
        <div class="rocket">
          <div class="nose"></div>
          <div class="body"></div>
          <div class="window"></div>
          <div class="fin left"></div>
          <div class="fin right"></div>
          <div class="flame"></div>
          <div class="warp"></div>
        </div>
      </div>
      <div id="countHero" class="brand text-2xl text-cyan-200">00:00:10</div>
      <div class="text-sm text-slate-400">Demo: cuenta regresiva</div>
    </div>
  </section>

  <!-- TABS -->
  <main class="max-w-6xl mx-auto p-4 md:p-8">
    <div class="flex flex-wrap gap-2 mb-4">
      <button class="tab-btn active-tab" data-tab="crear">Crear</button>
      <button class="tab-btn" data-tab="plantillas">Plantillas</button>
      <button class="tab-btn" data-tab="mis">Mis c√°psulas</button>
      <button class="tab-btn" data-tab="ayuda">Ayuda</button>
    </div>

    <!-- CREAR -->
    <section id="crear" class="glass p-6 grid md:grid-cols-2 gap-8">
      <div class="space-y-4">
        <div>
          <div class="label">T√≠tulo *</div>
          <input id="capTitle" class="input" placeholder="Ej: Carta al yo del futuro">
        </div>
        <div>
          <div class="label">Mensaje *</div>
          <textarea id="capMsg" class="textarea h-40" placeholder="Escribe tu mensaje‚Ä¶"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">Fecha y hora *</div>
            <input id="capOpenAt" type="datetime-local" class="input">
          </div>
          <div>
            <div class="label">Zona horaria</div>
            <select id="capTZ" class="input">
              <option value="local">Autom√°tica (local)</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">Seguridad</div>
            <select id="capSec" class="input">
              <option value="link">Clave en enlace</option>
              <option value="pin">Derivar por PIN (PBKDF2)</option>
            </select>
          </div>
          <div id="pinWrap" class="hidden">
            <div class="label">PIN (4‚Äì8)</div>
            <input id="capPIN" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="1234">
          </div>
        </div>

        <!-- Tipo de c√°psula (algunas son Pro) -->
        <div class="glass p-4">
          <div class="label">Tipo</div>
          <div class="grid grid-cols-2 gap-2">
            <label class="flex items-center gap-2"><input type="radio" name="capType" value="personal" checked>Personal</label>
            <label class="flex items-center gap-2"><input type="radio" name="capType" value="video">Video Selfie <span class="text-xs text-emerald-400 hidden" id="tagVideoPro">PRO</span></label>
            <label class="flex items-center gap-2"><input type="radio" name="capType" value="prediction">IA Predictiva <span class="text-xs text-emerald-400 hidden" id="tagIAPRO">PRO</span></label>
            <label class="flex items-center gap-2"><input type="radio" name="capType" value="challenge">Desaf√≠o</label>
          </div>
        </div>

        <!-- Video Selfie (Pro) -->
        <div id="videoSection" class="hidden glass p-4">
          <div class="label">Video Selfie</div>
          <video id="videoPreview" class="w-full rounded border border-white/10 max-h-52" muted></video>
          <div class="flex gap-2 mt-2">
            <button id="startRecord" class="btn btn-primary">Grabar</button>
            <button id="stopRecord" class="btn btn-ghost hidden">Parar</button>
            <button id="playRecord" class="btn btn-ghost hidden">Ver</button>
          </div>
          <div id="recordingStatus" class="text-xs text-slate-400 mt-1"></div>
        </div>

        <!-- IA Predictiva (Pro demo local) -->
        <div id="aiSection" class="hidden glass p-4">
          <div class="label">IA Predictiva</div>
          <button id="generatePrediction" class="btn btn-primary">Generar predicci√≥n</button>
          <div id="aiPrediction" class="hidden p-3 rounded bg-white/5 border border-white/10 mt-2">
            <div class="text-sm text-cyan-300 mb-1">Predicci√≥n:</div>
            <div id="predictionText" class="text-sm text-slate-200"></div>
          </div>
        </div>

        <div>
          <div class="label">Adjuntar archivo (imagen/video hasta <span id="maxSizeLabel">10</span> MB).</div>
          <input id="capFile" type="file" accept="image/*,video/*" class="input">
          <div id="fileHint" class="text-xs text-slate-400 mt-1"></div>
        </div>

        <div>
          <div class="label">Enlaces (YouTube/Drive/Dropbox, opcional)</div>
          <input id="capLinks" class="input" placeholder="URL 1, URL 2, ‚Ä¶">
        </div>

        <!-- Recurrencia -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <div class="label">Recurrencia</div>
            <select id="capRecur" class="input">
              <option value="none">Sin repetici√≥n</option>
              <option value="weekly">Semanal</option>
              <option value="monthly">Mensual</option>
              <option value="yearly">Anual</option>
            </select>
          </div>
          <div>
            <div class="label">Cantidad (m√°x 24)</div>
            <input id="capRecurCount" type="number" min="1" max="24" class="input" placeholder="Ej: 12">
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button id="btnCreate" class="btn btn-primary">Guardar c√°psula</button>
          <button id="btnPreview" class="btn btn-ghost">Previsualizar</button>
        </div>

        <!-- Backup -->
        <div class="flex gap-3 pt-2">
          <button id="btnExport" type="button" class="btn btn-ghost">Exportar backup</button>
          <label class="btn btn-ghost cursor-pointer">
            Importar backup
            <input id="importFile" type="file" accept="application/json" class="hidden">
          </label>
        </div>
        <p class="text-xs text-slate-400">* Requisito: m√≠nimo +30s en el futuro.</p>
      </div>

      <!-- Compartir -->
      <div class="space-y-4">
        <div class="p-4 glass">
          <div class="brand font-extrabold mb-2 text-cyan-200">Compartir</div>
          <div class="label mb-1">Enlace</div>
          <div class="flex gap-2">
            <input id="shareLink" class="input flex-1" readonly placeholder="Se completa al guardar">
            <button id="copyLink" class="btn btn-ghost">Copiar</button>
          </div>
          <div class="label mt-3 mb-1">QR del enlace</div>
          <div id="qr" class="flex items-center justify-center p-4 rounded-xl border border-white/10"></div>

          <div class="mt-3">
            <div class="label mb-1">WhatsApp</div>
            <textarea id="waText" class="textarea h-20" placeholder="Te comparto esta c√°psula ‚è≥‚ú®"></textarea>
            <button id="waBtn" class="btn btn-primary mt-2">Enviar por WhatsApp</button>
          </div>

          <div class="mt-2 flex gap-2">
            <button id="tgBtn" class="btn btn-ghost">Telegram</button>
            <button id="mailBtn" class="btn btn-ghost">Email</button>
          </div>
        </div>

        <div class="p-4 glass">
          <div class="brand font-extrabold mb-2 text-cyan-200">Calendario</div>
          <button id="btnICS" class="btn btn-ghost">Descargar .ics</button>
          <p class="text-xs text-slate-400 mt-1">Agrega un recordatorio en Google/Apple Calendar.</p>
        </div>
      </div>
    </section>

    <!-- PLANTILLAS -->
    <section id="plantillas" class="hidden glass p-6">
      <div class="brand text-xl mb-4">Plantillas r√°pidas</div>
      <div class="grid md:grid-cols-3 gap-3" id="tplList"></div>
    </section>

    <!-- MIS C√ÅPSULAS -->
    <section id="mis" class="hidden glass p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="brand text-xl">Mis c√°psulas</div>
        <input id="search" class="input max-w-xs" placeholder="Buscar por t√≠tulo‚Ä¶">
      </div>

      <div id="metrics" class="glass p-3 mb-3 text-sm grid grid-cols-2 md:grid-cols-4 gap-2">
        <div><div class="text-slate-400">Creadas</div><div id="mTotal" class="font-bold">0</div></div>
        <div><div class="text-slate-400">Abiertas</div><div id="mOpen" class="font-bold">0</div></div>
        <div><div class="text-slate-400">Open rate</div><div id="mRate" class="font-bold">0%</div></div>
        <div><div class="text-slate-400">Demora prom.</div><div id="mDelay" class="font-bold">0d</div></div>
      </div>

      <div id="myList" class="grid md:grid-cols-2 gap-4"></div>
      <div class="text-xs text-slate-400 mt-2">Guardado local (sin backend). Con Firebase habilitamos adjuntos grandes y automatizaciones.</div>
    </section>

    <!-- AYUDA -->
    <section id="ayuda" class="hidden glass p-6">
      <div class="brand text-xl mb-2">Ayuda r√°pida</div>
      <ol class="list-decimal pl-5 space-y-2 text-slate-300">
        <li>Complet√° T√≠tulo, Mensaje y Fecha (‚â• +30s).</li>
        <li>Modo seguridad: <b>Clave en enlace</b> o <b>PIN</b>.</li>
        <li>Adjunt√° imagen/video (‚â§ <span id="maxSizeHelp">10</span> MB). Im√°genes se comprimen.</li>
        <li>Guard√° ‚Üí se genera <b>link</b> + <b>QR</b> + <b>WhatsApp/Telegram/Email</b>.</li>
        <li>Al abrir el link: countdown ‚Üí <b>nave despega</b> ‚Üí contenido.</li>
      </ol>
    </section>
  </main>

  <!-- MODAL VIEWER -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 p-4">
    <div class="max-w-2xl mx-auto glass p-6">
      <div class="flex items-center justify-between">
        <span id="mPrivacy" class="text-xs px-2 py-1 rounded-full border border-white/15">C√°psula</span>
        <button id="mClose" class="btn btn-ghost">Cerrar</button>
      </div>
      <div id="mTitle" class="brand text-2xl mt-2 text-cyan-200">T√≠tulo</div>

      <!-- NAVE EN MODAL -->
      <div class="flex items-center justify-center my-5">
        <div id="mNave" class="nave">
          <div class="rocket">
            <div class="nose"></div>
            <div class="body"></div>
            <div class="window"></div>
            <div class="fin left"></div>
            <div class="fin right"></div>
            <div class="flame"></div>
            <div class="warp"></div>
          </div>
        </div>
      </div>

      <div id="mCountdown" class="brand text-3xl text-cyan-200 text-center mb-3">00:00:00</div>
      <div id="mPINwrap" class="hidden mb-3">
        <div class="label">Ingres√° PIN</div>
        <input id="mPIN" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <div id="mContent" class="hidden open-content space-y-3">
        <div id="mMessage" class="p-3 rounded-xl border border-white/10 bg-white/5"></div>
        <div id="mMedia"></div>
        <div id="mLinks" class="text-sm"></div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="mOpen" class="btn btn-primary hidden">Ver contenido</button>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div id="toasts" class="fixed bottom-4 right-4 grid gap-2 z-50"></div>

  <script>
  /* ============ Pago Pro (Stripe Payment Link) ============ */
  const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/xxxxxxxxxxxx"; // <-- Pega aqu√≠ tu Payment Link
  const isPro = ()=> localStorage.getItem('isPro') === '1';
  function setProUI(){
    document.getElementById('proBadge').classList.toggle('hidden', !isPro());
    document.getElementById('tagVideoPro').classList.toggle('hidden', !isPro());
    document.getElementById('tagIAPRO').classList.toggle('hidden', !isPro());
    document.getElementById('maxSizeLabel').textContent = isPro()? '50':'10';
    document.getElementById('maxSizeHelp').textContent = isPro()? '50':'10';
  }
  // Activaci√≥n autom√°tica si vuelve con ?pro=ok
  (function handleProReturn(){
    const sp = new URLSearchParams(location.search);
    if(sp.get('pro')==='ok'){ localStorage.setItem('isPro','1'); history.replaceState({},'',location.pathname); }
    setProUI();
  })();
  document.getElementById('btnGoPro').addEventListener('click', ()=>{
    window.open(STRIPE_PAYMENT_LINK, '_blank');
  });

  /* ================== Helpers ================== */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toast = (msg)=> {
    const n = document.createElement('div');
    n.className = 'glass px-3 py-2 rounded-lg';
    n.textContent = msg;
    $('#toasts').appendChild(n);
    setTimeout(()=>{ n.remove(); }, 2600);
  };
  const fmt = (d)=> new Date(d).toLocaleString();

  /* ================== Tema ================== */
  (function initTheme(){
    const sel = $('#themeSel');
    const saved = localStorage.getItem('theme')||'dark';
    document.documentElement.setAttribute('data-theme', saved);
    sel.value = saved;
    sel.addEventListener('change', ()=>{
      const v = sel.value==='auto'
        ? (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light')
        : sel.value;
      document.documentElement.setAttribute('data-theme', v);
      localStorage.setItem('theme', sel.value);
    });
  })();

  /* ================== Tabs ================== */
  $$('.tab-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('.tab-btn').forEach(x=>x.classList.remove('active-tab'));
      b.classList.add('active-tab');
      ['crear','plantillas','mis','ayuda'].forEach(id=>$('#'+id).classList.add('hidden'));
      $('#'+b.dataset.tab).classList.remove('hidden');
      if(b.dataset.tab==='mis') renderMyCaps();
      if(b.dataset.tab==='plantillas') renderTpls();
    });
  });

  /* ================== Crypto (AES-256-GCM + PBKDF2) ================== */
  const Crypto = {
    async genKey(){ return crypto.getRandomValues(new Uint8Array(32)); },
    async keyFromPIN(pin, salt){
      const enc = new TextEncoder();
      const base = await crypto.subtle.importKey('raw', enc.encode(pin), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt, iterations:100000, hash:'SHA-256'},
        base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
      );
    },
    async importRawKey(raw){ return crypto.subtle.importKey('raw', raw, 'AES-GCM', false, ['encrypt','decrypt']); },
    b64e(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); },
    b64d(str){ return Uint8Array.from(atob(str), c=>c.charCodeAt(0)); },
    async encryptJson(obj, keyMode, pinOrKey){
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const enc = new TextEncoder().encode(JSON.stringify(obj));
      let cryptoKey, salt=null, keyBytes=null;
      if(keyMode==='pin'){
        salt = crypto.getRandomValues(new Uint8Array(16));
        cryptoKey = await this.keyFromPIN(pinOrKey, salt);
      }else{
        keyBytes = pinOrKey;
        cryptoKey = await this.importRawKey(keyBytes);
      }
      const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, cryptoKey, enc);
      return { iv: this.b64e(iv), salt: salt? this.b64e(salt): null, data: this.b64e(ct), key: keyBytes? this.b64e(keyBytes): null };
    },
    async decryptJson(encPack, keyMode, pinOrKey){
      const iv = this.b64d(encPack.iv);
      let cryptoKey;
      if(keyMode==='pin'){
        const salt = this.b64d(encPack.salt);
        cryptoKey = await this.keyFromPIN(pinOrKey, salt);
      }else{
        const keyBytes = this.b64d(pinOrKey);
        cryptoKey = await this.importRawKey(keyBytes);
      }
      const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, cryptoKey, this.b64d(encPack.data));
      return JSON.parse(new TextDecoder().decode(pt));
    }
  };

  /* ================== DB Local + M√©tricas ================== */
  const DB = {
    all(){ return JSON.parse(localStorage.getItem('caps')||'[]'); },
    saveAll(list){ localStorage.setItem('caps', JSON.stringify(list)); },
    put(c){
      const a=this.all(); const i=a.findIndex(x=>x.id===c.id);
      if(i>=0) a[i]=c; else a.push(c);
      this.saveAll(a);
    },
    get(id){ return this.all().find(x=>x.id===id); },
    del(id){ this.saveAll(this.all().filter(x=>x.id!==id)); },
    markOpened(id){
      const a=this.all(); const i=a.findIndex(x=>x.id===id);
      if(i<0) return;
      a[i].stats = a[i].stats || {opens:0};
      a[i].stats.opens = (a[i].stats.opens||0)+1;
      a[i].stats.lastOpenedAt = Date.now();
      this.saveAll(a);
    },
    metrics(){
      const list = this.all();
      const total = list.length;
      const opened = list.reduce((n,c)=> n + (c.stats?.opens?1:0), 0);
      const rate = total? Math.round(opened*100/total): 0;
      const avgDelayDays = total? Math.round(
        list.reduce((sum,c)=> sum + Math.max(0,(new Date(c.openAt).getTime() - (c.createdAt||0)))/(86400000), 0)/total
      ): 0;
      return { total, opened, rate, avgDelayDays };
    }
  };

  /* ================== Markdown b√°sico ================== */
  function mdSafe(s){
    const esc = (s||'').replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
    return esc
      .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
      .replace(/\*(.+?)\*/g,'<i>$1</i>')
      .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a class="text-cyan-300 underline" target="_blank" rel="noopener" href="$2">$1</a>')
      .replace(/\n/g,'<br>');
  }

  /* ================== Imagen comprimida ================== */
  async function imageToDataUrl(file){
    return new Promise((res,rej)=>{
      const img = new Image();
      const fr = new FileReader();
      fr.onload = ()=>{ img.src = fr.result; };
      fr.onerror = rej;
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const maxW = 1280;
        const scale = Math.min(1, maxW / img.width);
        canvas.width = Math.round(img.width*scale);
        canvas.height = Math.round(img.height*scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        res(canvas.toDataURL('image/jpeg',0.8));
      };
      fr.readAsDataURL(file);
    });
  }

  /* ================== Video selfie (grabaci√≥n) ================== */
  let mediaStream = null, mediaRecorder = null, recordedBlobs = [];
  async function startVideo(){
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
      $('#videoPreview').srcObject = mediaStream;
      $('#videoPreview').play();
    }catch(e){ toast('Permiso de c√°mara/micr√≥fono denegado'); }
  }
  function stopVideo(){
    mediaStream?.getTracks()?.forEach(t=>t.stop());
    $('#videoPreview').srcObject = null;
  }
  $('#startRecord').addEventListener('click', async ()=>{
    if(!isPro()){ toast('Funci√≥n Pro'); return; }
    await startVideo();
    recordedBlobs = [];
    mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'video/webm;codecs=vp9' });
    mediaRecorder.ondataavailable = e=>{ if(e.data.size>0) recordedBlobs.push(e.data); };
    mediaRecorder.onstop = ()=>{ stopVideo(); $('#playRecord').classList.remove('hidden'); };
    mediaRecorder.start(200);
    $('#recordingStatus').textContent='Grabando‚Ä¶';
    $('#startRecord').classList.add('hidden');
    $('#stopRecord').classList.remove('hidden');
  });
  $('#stopRecord').addEventListener('click', ()=>{
    mediaRecorder?.stop();
    $('#recordingStatus').textContent='Grabaci√≥n lista';
    $('#stopRecord').classList.add('hidden');
    $('#startRecord').classList.remove('hidden');
  });
  $('#playRecord').addEventListener('click', ()=>{
    if(!recordedBlobs.length) return;
    const blob = new Blob(recordedBlobs,{type:'video/webm'});
    $('#videoPreview').srcObject = null;
    $('#videoPreview').src = URL.createObjectURL(blob);
    $('#videoPreview').controls = true;
    $('#videoPreview').play();
  });

  /* ================== UI din√°micas por tipo ================== */
  const pinWrap = $('#pinWrap');
  $('#capSec').addEventListener('change', ()=> {
    pinWrap.classList.toggle('hidden', $('#capSec').value!=='pin');
  });
  function updateTypeUI(){
    const v = (document.querySelector('input[name="capType"]:checked')||{}).value;
    $('#videoSection').classList.toggle('hidden', v!=='video');
    $('#aiSection').classList.toggle('hidden', v!=='prediction');
  }
  $$('input[name="capType"]').forEach(r=> r.addEventListener('change', updateTypeUI));
  updateTypeUI();

  /* ================== Archivo seleccionado ================== */
  $('#capFile').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f){ $('#fileHint').textContent=''; return; }
    const limitMB = isPro()? 50 : 10;
    if(f.size > limitMB*1024*1024){ $('#fileHint').textContent=`Archivo >${limitMB}MB. Sube a Drive/YouTube o consigue Pro.`; e.target.value=''; return; }
    if(f.type.startsWith('image/')) $('#fileHint').textContent='Imagen: se comprimir√°.';
    else if(f.type.startsWith('video/')) $('#fileHint').textContent='Video: si es grande, usar YouTube/Drive.';
    else $('#fileHint').textContent='Tipo soportado.';
  });

  /* ================== Crear c√°psula ================== */
  let lastShareUrl = '';
  $('#btnCreate').addEventListener('click', async ()=>{
    try{
      const title = $('#capTitle').value.trim();
      const message = $('#capMsg').value.trim();
      const openAt = $('#capOpenAt').value;
      if(!title || !message || !openAt){ toast('Complet√° t√≠tulo, mensaje y fecha.'); return; }
      const openTs = new Date(openAt).getTime();
      if(isNaN(openTs) || openTs < Date.now()+30000){ toast('La fecha debe ser al menos +30s.'); return; }

      const sec = $('#capSec').value;
      let pin = null;
      if(sec==='pin'){
        pin = $('#capPIN').value.trim();
        if(!/^\d{4,8}$/.test(pin)){ toast('PIN de 4 a 8 d√≠gitos.'); return; }
      }

      // Tipo / IA
      const capType = (document.querySelector('input[name="capType"]:checked')||{}).value || 'personal';
      let predictionText = null;
      if(capType==='prediction'){
        if(!isPro()){ toast('IA Predictiva es Pro'); return; }
        predictionText = $('#predictionText').textContent || 'Predicci√≥n local de ejemplo: tu disciplina atraer√° oportunidades significativas.';
      }

      // Adjuntos
      let filePack = null;
      const f = $('#capFile').files[0];
      if(f){
        if(f.type.startsWith('image/')){
          const dataUrl = await imageToDataUrl(f);
          filePack = {name:f.name, type:'image/jpeg', dataUrl};
        }else if(f.type.startsWith('video/')){
          const buf = await f.arrayBuffer();
          if(buf.byteLength <= (isPro()? 50:10)*1024*1024){
            filePack = {name:f.name, type:f.type, dataUrl:'data:'+f.type+';base64,'+Crypto.b64e(buf)};
          }else{
            filePack = {name:f.name, type:f.type, dataUrl:null, note:'Video grande: usar enlace (YouTube/Drive).'};
          }
        }
      }
      // Video selfie si no se us√≥ file input
      if(!filePack && capType==='video' && recordedBlobs.length){
        if(!isPro()){ toast('Video selfie es Pro'); return; }
        const blob = new Blob(recordedBlobs,{type:'video/webm'});
        const buffer = await blob.arrayBuffer();
        filePack = {name:'video_selfie.webm', type:'video/webm', dataUrl:'data:video/webm;base64,'+Crypto.b64e(buffer)};
      }

      const links = $('#capLinks').value.split(',').map(s=>s.trim()).filter(Boolean);

      // Base de contenido cifrado
      const plainBase = {title, message, file:filePack, links, type:capType, prediction:predictionText};

      // Recurrencia
      const recur = $('#capRecur').value;
      const recurCount = Math.min(24, Math.max(1, parseInt($('#capRecurCount').value||'0',10) || 1));
      const series = [];
      function addUnit(d,unit){
        const nd = new Date(d);
        if(unit==='weekly') nd.setDate(nd.getDate()+7);
        if(unit==='monthly') nd.setMonth(nd.getMonth()+1);
        if(unit==='yearly') nd.setFullYear(nd.getFullYear()+1);
        return nd;
      }
      const firstDate = new Date(openAt);
      if(recur!=='none' && recurCount>1){
        let cur = new Date(firstDate);
        for(let i=0;i<recurCount;i++){
          series.push(new Date(cur));
          cur = addUnit(cur, recur);
        }
      } else {
        series.push(firstDate);
      }

      let lastUrl = '';
      for(const dt of series){
        const secMode = (sec==='pin')?'pin':'link';
        let localKey=null, localPin=null;
        if(secMode==='pin'){
          localPin = pin;
        } else {
          localKey = await Crypto.genKey();
        }

        const encPack = await Crypto.encryptJson(plainBase, secMode, secMode==='pin'?localPin:localKey);
        const cap = {
          id: 'c_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
          title,
          openAt: dt.toISOString(),
          tz: $('#capTZ').value,
          sec,
          enc: { iv: encPack.iv, salt: encPack.salt, data: encPack.data },
          k: encPack.key || null,
          createdAt: Date.now()
        };
        DB.put(cap);

        // Link portable
        const payload = {v:1, id:cap.id, openAt:cap.openAt, tz:cap.tz, sec:cap.sec, enc:cap.enc};
        const packed = LZString.compressToEncodedURIComponent(JSON.stringify(payload));
        let hash = `#d=${packed}`; if(cap.sec==='link' && cap.k) hash += `&k=${encodeURIComponent(cap.k)}`;
        const base = location.href.split('#')[0].split('?')[0];
        lastUrl = `${base}${hash}`;
      }

      lastShareUrl = lastUrl;
      $('#shareLink').value = lastUrl;
      $('#qr').innerHTML = ''; new QRCode($('#qr'), {text:lastUrl, width:180, height:180});
      if(!$('#waText').value) $('#waText').value = 'Abr√≠ mi c√°psula del tiempo ‚è≥‚ú®';

      toast(series.length>1 ? `Se crearon ${series.length} c√°psulas (serie) ‚úÖ` : 'C√°psula creada. Link listo ‚úÖ');
      renderMyCaps();
    }catch(e){ console.error(e); toast('Error creando la c√°psula'); }
  });

  $('#copyLink').addEventListener('click', async ()=>{
    if(!$('#shareLink').value){ toast('Guard√° la c√°psula primero.'); return; }
    await navigator.clipboard.writeText($('#shareLink').value);
    toast('Enlace copiado ‚úÖ');
  });

  $('#waBtn').addEventListener('click', ()=>{
    if(!$('#shareLink').value){ toast('Guard√° la c√°psula primero.'); return; }
    const msg = `${$('#waText').value}\n${$('#shareLink').value}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
  });

  $('#tgBtn').addEventListener('click', ()=>{
    const url = $('#shareLink').value;
    if(!url){ toast('Guard√° la c√°psula primero.'); return; }
    const text = $('#waText').value || 'Abr√≠ mi c√°psula del tiempo ‚è≥‚ú®';
    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,'_blank');
  });
  $('#mailBtn').addEventListener('click', ()=>{
    const url = $('#shareLink').value;
    if(!url){ toast('Guard√° la c√°psula primero.'); return; }
    const subject = 'C√°psula del tiempo';
    const body = `${($('#waText').value||'Te comparto esta c√°psula ‚è≥‚ú®')}\n\n${url}`;
    location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });

  // Previsualizaci√≥n
  $('#btnPreview').addEventListener('click', ()=> { openModalPreview(); });

  /* ================== .ICS (calendario) ================== */
  $('#btnICS').addEventListener('click', ()=>{
    const title = $('#capTitle').value||'C√°psula';
    const dt = $('#capOpenAt').value;
    if(!dt){ toast('Defin√≠ la fecha primero.'); return; }
    const dtUTC = new Date(dt).toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    const ics = [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Capsula//EN','BEGIN:VEVENT',
      `DTSTAMP:${dtUTC}`,`UID:${crypto.randomUUID()}@capsula`,
      `DTSTART:${dtUTC}`,`SUMMARY:${title} (C√°psula)`,
      'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
    a.download = 'capsula.ics'; a.click();
  });

  /* ================== Mis c√°psulas ================== */
  function renderMetrics(){
    const { total, opened, rate, avgDelayDays } = DB.metrics();
    $('#mTotal').textContent = total;
    $('#mOpen').textContent = opened;
    $('#mRate').textContent = rate + '%';
    $('#mDelay').textContent = avgDelayDays + 'd';
  }

  function renderMyCaps(q=''){
    const list = DB.all().filter(c=>c.title.toLowerCase().includes(q.toLowerCase()));
    const box = $('#myList'); box.innerHTML='';
    if(!list.length){ box.innerHTML='<div class="text-slate-400 text-sm">No hay c√°psulas.</div>'; renderMetrics(); return; }
    list.sort((a,b)=>b.createdAt-a.createdAt);
    for(const c of list){
      const card = document.createElement('div');
      card.className = 'glass p-4';
      card.innerHTML = `
        <div class="font-bold">${c.title}</div>
        <div class="text-sm text-slate-400 mb-2">Se abre: ${fmt(c.openAt)}</div>
        <div class="flex gap-2">
          <button class="btn btn-ghost" data-act="open" data-id="${c.id}">Abrir</button>
          <button class="btn btn-ghost" data-act="share" data-id="${c.id}">Link</button>
          <button class="btn btn-ghost" data-act="del" data-id="${c.id}">Eliminar</button>
        </div>`;
      box.appendChild(card);
    }
    renderMetrics();
  }
  $('#search').addEventListener('input', (e)=> renderMyCaps(e.target.value));
  $('#myList').addEventListener('click', (e)=>{
    if(!(e.target instanceof HTMLElement)) return;
    const id = e.target.getAttribute('data-id');
    const act = e.target.getAttribute('data-act');
    if(!id||!act) return;
    const cap = DB.get(id);
    if(!cap) return;

    if(act==='del'){ DB.del(id); renderMyCaps($('#search').value); toast('Eliminada'); return; }
    if(act==='share'){
      const payload = { v:1, id:cap.id, openAt:cap.openAt, tz:cap.tz, sec:cap.sec, enc:cap.enc };
      const packed = LZString.compressToEncodedURIComponent(JSON.stringify(payload));
      let hash = `#d=${packed}`;
      if (cap.sec === 'link' && cap.k) hash += `&k=${encodeURIComponent(cap.k)}`;
      const base = location.href.split('#')[0].split('?')[0];
      const shareUrl = `${base}${hash}`;
      navigator.clipboard.writeText(shareUrl);
      toast('Enlace de la c√°psula copiado ‚úÖ');
      return;
    }
    if(act==='open'){ openModal(cap); }
  });

  /* ================== Modal / apertura (Nave) ================== */
  const modal = $('#modal');
  $('#mClose').addEventListener('click', ()=> modal.classList.add('hidden'));

  function startCountdown(ts, el){
    function tick(){
      const d = Math.max(0, ts - Date.now());
      const s = Math.floor(d/1000);
      const h = String(Math.floor(s/3600)).padStart(2,'0');
      const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const sc = String(s%60).padStart(2,'0');
      el.textContent = `${h}:${m}:${sc}`;
    }
    tick();
    return setInterval(tick, 1000);
  }

  async function openModal(cap){
    modal.classList.remove('hidden');
    $('#mTitle').textContent = cap.title || 'C√°psula';
    $('#mContent').classList.add('hidden');
    $('#mPINwrap').classList.toggle('hidden', cap.sec!=='pin');

    const nave = $('#mNave');
    nave.classList.remove('launch');

    const target = new Date(cap.openAt).getTime();
    const iv = startCountdown(target, $('#mCountdown'));
    $('#mOpen').classList.toggle('hidden', Date.now()<target);

    const opener = async ()=>{
      if(Date.now()<target){ toast('A√∫n no se puede abrir.'); return; }
      clearInterval(iv);
      // Despegue
      nave.classList.add('launch');
      setTimeout(()=>{ nave.parentElement.classList.add('hidden'); }, 900);
      await openContent(cap);
    };
    $('#mOpen').onclick = opener;
  }

  async function openContent(cap){
    try{
      let keyMode = cap.sec==='pin'?'pin':'link';
      let keyOrPin;
      if(keyMode==='pin'){
        keyOrPin = $('#mPIN').value.trim();
        if(!/^\d{4,8}$/.test(keyOrPin)){ toast('PIN inv√°lido'); return; }
      }else{
        const k = (new URLSearchParams(location.hash.slice(1))).get('k') || cap.k;
        if(!k){ toast('Falta clave en enlace.'); return; }
        keyOrPin = k;
      }
      const plain = await Crypto.decryptJson(cap.enc, keyMode, keyOrPin);
      showDecrypted(plain);
      confetti({particleCount:200,spread:120,origin:{y:.6}});
      if(cap.id && DB.get(cap.id)){ DB.markOpened(cap.id); renderMetrics(); }
    }catch(e){ console.error(e); toast('No se pudo descifrar.'); }
  }

  function showDecrypted(plain){
    $('#mContent').classList.remove('hidden');
    $('#mMessage').innerHTML = mdSafe(plain.message||'');
    const media = $('#mMedia'); media.innerHTML='';
    if(plain.file && (plain.file.dataUrl || plain.file.url)){
      const src = plain.file.dataUrl || plain.file.url;
      if((plain.file.type||'').startsWith('image/')){
        const img = document.createElement('img');
        img.src = src; img.className='max-h-[420px] w-full object-contain rounded-xl border border-white/10';
        media.appendChild(img);
      }else if((plain.file.type||'').startsWith('video/')){
        const v = document.createElement('video');
        v.controls = true; v.src = src; v.className='w-full rounded-xl border border-white/10';
        media.appendChild(v);
      }else{
        const a=document.createElement('a'); a.href=src; a.target='_blank'; a.rel='noopener'; a.textContent=plain.file.name||'Descargar archivo'; a.className='underline';
        media.appendChild(a);
      }
    }
    const links = $('#mLinks'); links.innerHTML='';
    if(plain.links?.length){
      const ul = document.createElement('ul'); ul.className='list-disc pl-5';
      plain.links.forEach(u=>{
        const li=document.createElement('li');
        const a=document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noopener'; a.textContent=u; a.className='text-cyan-300 underline';
        li.appendChild(a); ul.appendChild(li);
      });
      links.appendChild(ul);
    }
    // Si hay predicci√≥n (Pro)
    if(plain.prediction){
      const box = document.createElement('div');
      box.className = 'p-3 rounded-xl border border-white/10 bg-white/5';
      box.innerHTML = `<div class="text-sm text-emerald-300 mb-1">IA dijo:</div><div class="text-sm">${mdSafe(plain.prediction)}</div>`;
      media.appendChild(box);
    }
  }

  // Previsualizaci√≥n inmediata
  async function openModalPreview(){
    try{
      const title = $('#capTitle').value.trim() || 'Vista previa';
      const message = $('#capMsg').value.trim() || '‚Ä¶';
      const sec = $('#capSec').value;
      const capType = (document.querySelector('input[name="capType"]:checked')||{}).value || 'personal';

      let filePack = null;
      // de file input
      const f = $('#capFile').files[0];
      if(f){
        if(f.type.startsWith('image/')){
          const dataUrl = await imageToDataUrl(f);
          filePack = {name:f.name, type:'image/jpeg', dataUrl};
        }else if(f.type.startsWith('video/')){
          const buf = await f.arrayBuffer();
          const lim = (isPro()? 50:10)*1024*1024;
          if(buf.byteLength <= lim){
            filePack = {name:f.name, type:f.type, dataUrl:'data:'+f.type+';base64,'+Crypto.b64e(buf)};
          }
        }
      }
      // o de video selfie
      if(!filePack && capType==='video' && recordedBlobs.length){
        if(!isPro()){ toast('Video selfie es Pro'); return; }
        const blob = new Blob(recordedBlobs,{type:'video/webm'});
        const buf = await blob.arrayBuffer();
        filePack = {name:'video_selfie.webm', type:'video/webm', dataUrl:'data:video/webm;base64,'+Crypto.b64e(buf)};
      }

      const links = $('#capLinks').value.split(',').map(s=>s.trim()).filter(Boolean);
      const prediction = capType==='prediction' ? ($('#predictionText').textContent || 'Predicci√≥n de ejemplo‚Ä¶') : null;

      let rawKey=null, pin=null;
      if (sec==='pin') pin = $('#capPIN').value.trim() || '1234'; else rawKey = await Crypto.genKey();

      const plain = { title, message, file:filePack, links, type:capType, prediction };
      const encPack = await Crypto.encryptJson(plain, sec==='pin'?'pin':'link', sec==='pin'?pin:rawKey);

      const cap = {
        id: 'preview_'+Date.now(),
        title, openAt: new Date(Date.now()-1000).toISOString(), tz: 'local', sec,
        enc: { iv: encPack.iv, salt: encPack.salt, data: encPack.data },
        k: encPack.key || null
      };
      openModal(cap);
      $('#mOpen').classList.remove('hidden');
    }catch(e){ console.error(e); toast('No se pudo generar la previsualizaci√≥n'); }
  }

  /* ================== Plantillas ================== */
  const TPLS = [
    {name:'Cumplea√±os anual üéÇ', title:'¬°Feliz cumple ${nombre}!', message:'Hoy cumpl√≠s ${edad}! Que sea un a√±o incre√≠ble üôå', delayDays:365, vars:['nombre','edad']},
    {name:'Aniversario üíû', title:'Feliz aniversario ${nombre} üíñ', message:'Gracias por otro a√±o juntos', delayDays:365, vars:['nombre']},
    {name:'Objetivo trimestral üéØ', title:'Revisi√≥n Q${q}', message:'Logros, pendientes y foco del pr√≥ximo trimestre.', delayDays:90, vars:['q']},
    {name:'Motivaci√≥n semanal üöÄ', title:'Semana ${n}', message:'Recordatorio: foco, energ√≠a y constancia.', delayDays:7, vars:['n']}
  ];
  function renderTpls(){
    const box = $('#tplList'); box.innerHTML='';
    TPLS.forEach(t=>{
      const d = document.createElement('div');
      d.className='glass p-4';
      d.innerHTML = `<div class="font-bold mb-1">${t.name}</div>
        <div class="text-slate-300 text-sm mb-3">${t.message}</div>
        <button class="btn btn-primary">Usar</button>`;
      d.querySelector('button').onclick = async ()=>{
        const vals = {};
        for(const v of (t.vars||[])){
          const r = prompt(`Valor para "${v}":`,'');
          if(r===null) return;
          vals[v]=r;
        }
        const interp = (s)=> s.replace(/\$\{(\w+)\}/g, (_,k)=> (vals[k]??''));
        $('#capTitle').value = interp(t.title);
        $('#capMsg').value = interp(t.message);
        const dt = new Date(Date.now()+t.delayDays*24*3600*1000).toISOString().slice(0,16);
        $('#capOpenAt').value = dt;
        toast('Plantilla aplicada ‚úî');
        document.querySelector('[data-tab="crear"]').click();
      };
      box.appendChild(d);
    });
  }

  /* ================== Apertura por #d=‚Ä¶ ================== */
  (function checkHashOpen(){
    if(!location.hash.startsWith('#d=')) return;
    try{
      const sp = new URLSearchParams(location.hash.slice(1));
      const data = sp.get('d'); if(!data) return;
      const payload = JSON.parse(LZString.decompressFromEncodedURIComponent(data));
      openModal(payload);
      $('#mOpen').classList.toggle('hidden', Date.now()<new Date(payload.openAt).getTime());
    }catch(e){ console.error(e); }
  })();

  /* ================== Hero demo (nave despega) ================== */
  (function heroDemo(){
    const nave = $('#naveHero');
    if(!nave) return;
    const target = Date.now()+10000;
    const el = $('#countHero');
    const iv = setInterval(()=>{
      const s = Math.max(0, Math.floor((target - Date.now())/1000));
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      el.textContent = `00:${m}:${ss}`;
      if(s<=0){
        clearInterval(iv);
        nave.classList.add('launch');
        setTimeout(()=> {
          confetti({particleCount:120,spread:80,origin:{y:.6}});
        }, 700);
      }
    }, 1000);
  })();

  /* ================== IA Predictiva (demo local) ================== */
  $('#generatePrediction').addEventListener('click', ()=>{
    if(!isPro()){ toast('Funci√≥n Pro'); return; }
    const base = $('#capMsg').value.trim() || 'Tu constancia actual';
    const candidates = [
      `${base} se convertir√° en logros concretos y mejoras notables en tu bienestar.`,
      `Recibir√°s una oportunidad inesperada que armoniza con tus metas actuales.`,
      `Har√°s un cambio de rumbo positivo que te permitir√° crecer con m√°s libertad.`,
      `Tu c√≠rculo cercano se fortalecer√° y te empujar√° a un nuevo desaf√≠o creativo.`
    ];
    const t = candidates[Math.floor(Math.random()*candidates.length)];
    $('#predictionText').textContent = t;
    $('#aiPrediction').classList.remove('hidden');
    toast('Predicci√≥n generada ‚ú®');
  });

  /* ================== Export/Import ================== */
  $('#btnExport').addEventListener('click', () => {
    const data = { version: '2.0', exported: new Date().toISOString(), capsules: DB.all() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `capsula-backup-${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    toast('Backup exportado ‚úÖ');
  });

  $('#importFile').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (data.capsules && Array.isArray(data.capsules)) {
        data.capsules.forEach(cap => DB.put(cap));
        toast(`${data.capsules.length} c√°psulas importadas ‚úÖ`);
        renderMyCaps();
      } else {
        toast('Formato de backup inv√°lido');
      }
    } catch (e) { toast('Error al importar backup'); }
    e.target.value = '';
  });

  /* ================== Init ================== */
  window.addEventListener('load', ()=>{
    renderMyCaps();
    renderTpls();
  });
  </script>
</body>
</html>
