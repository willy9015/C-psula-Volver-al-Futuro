  <!doctype html>
<html lang="es" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>C√°psula Volver al Futuro ‚Äî Pro Futurista</title>
  <meta name="theme-color" content="#0ea5e9">
  <meta name="description" content="Crea c√°psulas digitales con mensaje y fecha de apertura. Comparte por enlace, QR o WhatsApp. Con PIN opcional.">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Orbitron:wght@600;800&display=swap" rel="stylesheet">

  <!-- Libs UI -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- üî• Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script>
    // ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è RELLEN√Å CON TUS CLAVES DE FIREBASE ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_BUCKET.appspot.com",
      messagingSenderId: "XXXXXXXXXXXX",
      appId: "1:XXXXXXXXXXXX:web:XXXXXXXXXXXXXX"
    };
    // ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è RELLEN√Å CON TUS CLAVES DE FIREBASE ‚¨ÜÔ∏è‚¨ÜÔ∏è‚¨ÜÔ∏è

    // Inicializa Firebase solo si tiene claves reales (apiKey no vac√≠a)
    if (firebaseConfig.apiKey && !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      window.storage = firebase.storage();
    } else {
      window.storage = null; // sin Storage, seguimos con adjuntos por URL
    }
  </script>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#0f172a; --glassB:#ffffff10; --glassS:#ffffff18;
      --glow1:#22d3ee; --glow2:#a78bfa; --accent:#22d3ee;
      --fg:#e5e7eb; --muted:#cbd5e1; --muted2:#94a3b8; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.02);
    }
    [data-theme="light"]{
      --bg1:#f5f7fb; --bg2:#eef2ff; --glassB:#00000010; --glassS:#00000018;
      --fg:#0f172a; --muted:#334155; --muted2:#64748b; --panel:rgba(0,0,0,.03); --panel2:rgba(0,0,0,.01);
    }
    html,body{height:100%}
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(90vmax 60vmax at 10% 10%, #111827 0%, var(--bg1) 35%, var(--bg2) 100%);
      color:var(--fg);
    }
    .brand{font-family:Orbitron,Inter,sans-serif;letter-spacing:.5px}
    .glass{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--glassS);backdrop-filter:blur(10px)}
    .card{border-radius:1.25rem;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .btn{border-radius:.9rem;padding:.7rem 1rem;border:1px solid var(--glassS);transition:transform .08s ease,filter .2s}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn-primary{background:linear-gradient(90deg,var(--glow1),var(--glow2));color:#0b1220;font-weight:800;text-shadow:0 1px 0 rgba(255,255,255,.2)}
    .btn-ghost{background:rgba(255,255,255,.06);color:var(--fg)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.25)}
    .label{font-size:.85rem;font-weight:600;color:var(--muted)}
    .input,.textarea{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.14);border-radius:.9rem;padding:.8rem;color:var(--fg)}
    .input::placeholder,.textarea::placeholder{color:var(--muted2)}
    .pill{font-size:.72rem;background:rgba(255,255,255,.06);color:var(--muted);padding:.25rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.1)}
    .badge{font-size:.72rem;background:linear-gradient(90deg,rgba(34,211,238,.15),rgba(167,139,250,.15));color:#22d3ee;padding:.25rem .6rem;border:1px solid rgba(34,211,238,.3);border-radius:999px}
    .kbd{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#111827;border:1px solid #374151;padding:.15rem .4rem;border-radius:.375rem;font-size:.75rem}
    .cofre{width:260px;height:150px;position:relative;margin:0 auto;perspective:900px;filter:drop-shadow(0 10px 25px rgba(34,211,238,.25))}
    .cofre .base{position:absolute;inset:auto 0 0 0;height:70%;background:linear-gradient(180deg,#0ea5e9,#3b82f6);border-radius:0 0 16px 16px;box-shadow:inset 0 10px 0 rgba(0,0,0,.25)}
    .cofre .tapa{position:absolute;inset:0 0 auto 0;height:60%;background:linear-gradient(180deg,#a78bfa,#22d3ee);border-radius:16px 16px 10px 10px;transform-origin:top center;transition:transform .9s cubic-bezier(.2,.8,.2,1);box-shadow:inset 0 -10px 0 rgba(0,0,0,.25);transform:rotateX(0deg)}
    .cofre.open .tapa{transform:rotateX(72deg)}
    .glow-ring{position:absolute;inset:-10px;border-radius:20px;box-shadow:0 0 0 1px rgba(34,211,238,.25),0 0 40px 6px rgba(34,211,238,.15),inset 0 0 20px rgba(167,139,250,.2);pointer-events:none}
    .toast{position:fixed;bottom:18px;right:18px;z-index:1000;display:grid;gap:8px}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="sticky top-0 z-40 backdrop-blur border-b border-white/10" style="background:linear-gradient(180deg,rgba(11,18,32,.8),rgba(11,18,32,.35))">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="#crear" class="brand text-2xl font-extrabold tracking-tight">
        <span class="text-cyan-300" data-i18n="brandA">C√°psula</span> <span class="text-indigo-300" data-i18n="brandB">Volver al Futuro</span>
      </a>
      <div class="flex items-center gap-2">
        <select id="langSel" class="input !py-2 !px-3" style="width:auto">
          <option value="es">ES</option><option value="en">EN</option>
        </select>
        <select id="themeSel" class="input !py-2 !px-3" style="width:auto">
          <option value="auto" data-i18n="themeAuto">Auto</option>
          <option value="light" data-i18n="themeLight">Claro</option>
          <option value="dark" data-i18n="themeDark">Oscuro</option>
        </select>
        <nav class="hidden md:flex gap-2">
          <a href="#crear" class="btn btn-outline" data-i18n="navCreate">Crear</a>
          <a href="#mis" class="btn btn-outline" data-i18n="navMine">Mis c√°psulas</a>
          <a href="#ayuda" class="btn btn-outline" data-i18n="navHelp">Ayuda</a>
        </nav>
        <a href="#crear" class="md:hidden btn btn-primary" data-i18n="navCreate">Crear</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto p-4 md:p-8 grid md:grid-cols-2 gap-6 items-center">
    <div class="glass card p-6 md:p-8">
      <div class="badge mb-2" data-i18n="heroBadge">Futurista ‚Ä¢ Listo para producci√≥n (frontend)</div>
      <h1 class="brand text-3xl md:text-4xl font-extrabold leading-tight mb-2" data-i18n="heroTitle">Guarda hoy. Descubre ma√±ana.</h1>
      <p class="text-slate-300" data-i18n="heroDesc">Crea c√°psulas con <b>t√≠tulo</b>, <b>mensaje</b>, <b>fecha de apertura</b>, <b>PIN opcional</b> y <b>links</b>. Compart√≠ por <b>enlace</b>, <b>QR</b> o <b>WhatsApp</b>. Apertura con animaci√≥n y confeti.</p>
      <div class="flex gap-3 mt-5">
        <a href="#crear" class="btn btn-primary" data-i18n="ctaCreate">Crear c√°psula</a>
        <a href="#mis" class="btn btn-ghost" data-i18n="ctaMine">Ver mis c√°psulas</a>
      </div>
    </div>
    <div class="glass card p-6 md:p-8 text-center relative overflow-hidden">
      <div id="cofreHero" class="cofre mx-auto mb-6"><div class="tapa"></div><div class="base"></div><div class="glow-ring"></div></div>
      <div id="countHero" class="brand text-3xl font-extrabold text-cyan-200">00:00:00</div>
      <div class="text-sm text-slate-400 mt-1" data-i18n="heroDemo">Cuenta regresiva de demo</div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-4 md:p-8 grid gap-6">
    <!-- Crear -->
    <section id="crear" class="glass card p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="brand text-2xl font-extrabold" data-i18n="createTitle">Crear nueva c√°psula</h2>
        <div class="flex gap-2">
          <button id="btnExport" class="btn btn-ghost" title="Exportar backup" data-i18n="export">Exportar</button>
          <label class="btn btn-ghost cursor-pointer" title="Importar backup">
            <span data-i18n="import">Importar</span>
            <input id="importFile" type="file" accept="application/json" class="hidden">
          </label>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div>
            <label class="label" data-i18n="fTitle">T√≠tulo *</label>
            <input id="capTitle" class="input" placeholder="Ej: Carta al yo del futuro">
          </div>
          <div>
            <label class="label" data-i18n="fMsg">Mensaje *</label>
            <textarea id="capMessage" class="textarea h-40" placeholder="Escribe tu mensaje (texto)."></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label" data-i18n="fDate">Fecha y hora *</label>
              <input id="capOpen" type="datetime-local" class="input">
            </div>
            <div>
              <label class="label" data-i18n="fPIN">PIN (opcional)</label>
              <input id="capPIN" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="4‚Äì6">
            </div>
          </div>
          <div>
            <label class="label" data-i18n="fLinks">Adjuntos (enlaces, opcional)</label>
            <input id="capLinks" class="input" placeholder="URL 1, URL 2, ...">
            <p class="text-xs text-slate-400 mt-1" data-i18n="fLinksHint">Drive / YouTube / S3 / Dropbox.</p>
          </div>
          <!-- ‚¨áÔ∏è Nuevo: subida real a Firebase Storage -->
          <div>
            <label class="label">Subir archivo (video/imagen, opcional)</label>
            <input id="capFile" type="file" accept="video/*,image/*" class="input">
            <p class="text-xs text-slate-400 mt-1">Se sube al Storage y se vincula a la c√°psula.</p>
          </div>
          <div class="flex gap-3 pt-2">
            <button id="btnCreate" class="btn btn-primary" data-i18n="btnSave">Guardar c√°psula</button>
            <button id="btnPreview" class="btn btn-ghost" data-i18n="btnPreview">Previsualizar</button>
          </div>
          <p class="text-xs text-slate-500" data-i18n="req">* Campos obligatorios.</p>
        </div>

        <div class="space-y-4">
          <div class="p-4 glass card">
            <h3 class="brand font-extrabold mb-3 text-cyan-200" data-i18n="share">Compartir</h3>
            <div>
              <div class="label mb-1" data-i18n="shareQR">QR del enlace</div>
              <div id="qrPreview" class="flex items-center justify-center p-4 rounded-xl border border-white/10" style="background:var(--panel)"></div>
            </div>
            <div class="mt-3">
              <label class="label mb-1" data-i18n="shareLink">Enlace para compartir</label>
              <div class="flex gap-2">
                <input id="shareLink" class="input flex-1" readonly placeholder="Se completa al guardar">
                <button id="copyLinkBtn" class="btn btn-ghost" data-i18n="copy">Copiar</button>
              </div>
            </div>
            <div class="mt-3">
              <label class="label mb-1" data-i18n="waMsg">Mensaje (para WhatsApp)</label>
              <textarea id="shareMsg" class="textarea h-24" placeholder="Te dejo esta c√°psula para abrir en la fecha ‚ú®"></textarea>
              <div class="flex items-center gap-2 mt-2">
                <button id="waBtn" class="btn btn-primary" data-i18n="waSend">Enviar por WhatsApp</button>
                <span class="text-xs text-slate-400" data-i18n="waHint">Abre WhatsApp con el texto + enlace.</span>
              </div>
            </div>
            <div class="mt-3">
              <div class="label mb-1" data-i18n="waQR">QR de WhatsApp (mensaje + enlace)</div>
              <div id="waQr" class="flex items-center justify-center p-4 rounded-xl border border-white/10" style="background:var(--panel)"></div>
              <p class="text-xs text-slate-400 mt-1" data-i18n="waQRHint">Quien escanee abrir√° WhatsApp con tu mensaje y link.</p>
            </div>
          </div>
          <div class="p-4 glass card">
            <h3 class="brand font-extrabold mb-2 text-cyan-200" data-i18n="calendar">Agendar apertura</h3>
            <button id="btnICS" class="btn btn-ghost" data-i18n="dlIcs">Descargar .ics</button>
            <p class="text-xs text-slate-400 mt-1" data-i18n="icsHint">Para Google/Apple Calendar.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Mis c√°psulas -->
    <section id="mis" class="glass card p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="brand text-2xl font-extrabold" data-i18n="mineTitle">Mis c√°psulas</h2>
        <input id="search" class="input max-w-xs" placeholder="Buscar por t√≠tulo‚Ä¶">
      </div>
      <div id="myList" class="grid md:grid-cols-2 gap-4"></div>
      <p class="text-xs text-slate-400 mt-3" data-i18n="localHint">Guardado local (sin registro). Export√°/Import√° desde ‚ÄúCrear‚Äù.</p>
    </section>

    <!-- Ayuda -->
    <section id="ayuda" class="glass card p-6 md:p-8">
      <h2 class="brand text-2xl font-extrabold mb-3" data-i18n="helpTitle">Ayuda r√°pida</h2>
      <ol class="list-decimal pl-5 space-y-2 text-slate-300">
        <li data-i18n="help1">Complet√° t√≠tulo, mensaje y fecha (m√≠nimo +30 s).</li>
        <li data-i18n="help2">Guard√°. Copi√° el enlace o us√° el QR/WhatsApp.</li>
        <li data-i18n="help3">Si pusiste PIN, compartilo por separado.</li>
        <li data-i18n="help4">El enlace <span class="kbd">?capsule=ID</span> abre la vista con countdown.</li>
      </ol>
    </section>
  </main>

  <!-- Modal Viewer -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 p-4">
    <div class="max-w-2xl mx-auto glass card p-6 border border-white/10">
      <div class="flex items-center justify-between">
        <div id="mPrivacy" class="pill">P√∫blica</div>
        <button id="mClose" class="btn btn-ghost" aria-label="Cerrar" data-i18n="close">Cerrar</button>
      </div>
      <div id="mTitle" class="brand text-2xl font-extrabold mt-2 text-cyan-200">T√≠tulo</div>
      <div class="flex items-center justify-center my-5">
        <div id="mChest" class="cofre"><div class="tapa"></div><div class="base"></div><div class="glow-ring"></div></div>
      </div>
      <div id="mCountdown" class="brand text-3xl font-extrabold text-cyan-200 text-center mb-3">00:00:00</div>
      <div id="mPINwrap" class="hidden mb-3">
        <label class="label" data-i18n="enterPIN">Ingres√° PIN</label>
        <input id="mPIN" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="4‚Äì6">
      </div>
      <div id="mContent" class="hidden space-y-2">
        <div id="mMessage" class="p-3 rounded-xl border border-white/10" style="background:var(--panel)">...</div>
        <div id="mLinks"></div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="mOpen" class="btn btn-primary hidden" data-i18n="open">Ver contenido</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toast"></div>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const els = (sel,root=document)=>Array.from(root.querySelectorAll(sel));

    // ==== i18n packs ====
    const I18N = {
      es: { brandA:"C√°psula", brandB:"Volver al Futuro", themeAuto:"Auto", themeLight:"Claro", themeDark:"Oscuro",
        navCreate:"Crear", navMine:"Mis c√°psulas", navHelp:"Ayuda",
        heroBadge:"Futurista ‚Ä¢ Listo para producci√≥n (frontend)", heroTitle:"Guarda hoy. Descubre ma√±ana.",
        heroDesc:"Crea c√°psulas con <b>t√≠tulo</b>, <b>mensaje</b>, <b>fecha de apertura</b>, <b>PIN opcional</b> y <b>links</b>. Compart√≠ por <b>enlace</b>, <b>QR</b> o <b>WhatsApp</b>. Apertura con animaci√≥n y confeti.",
        heroDemo:"Cuenta regresiva de demo", ctaCreate:"Crear c√°psula", ctaMine:"Ver mis c√°psulas",
        createTitle:"Crear nueva c√°psula", export:"Exportar", import:"Importar",
        fTitle:"T√≠tulo *", fMsg:"Mensaje *", fDate:"Fecha y hora *", fPIN:"PIN (opcional)",
        fLinks:"Adjuntos (enlaces, opcional)", fLinksHint:"Drive / YouTube / S3 / Dropbox.",
        btnSave:"Guardar c√°psula", btnPreview:"Previsualizar", req:"* Campos obligatorios.",
        share:"Compartir", shareQR:"QR del enlace", shareLink:"Enlace para compartir",
        copy:"Copiar", waMsg:"Mensaje (para WhatsApp)", waSend:"Enviar por WhatsApp",
        waHint:"Abre WhatsApp con el texto + enlace.", waQR:"QR de WhatsApp (mensaje + enlace)",
        waQRHint:"Quien escanee abrir√° WhatsApp con tu mensaje y link.",
        calendar:"Agendar apertura", dlIcs:"Descargar .ics", icsHint:"Para Google/Apple Calendar.",
        mineTitle:"Mis c√°psulas", localHint:"Guardado local (sin registro). Export√°/Import√° desde ‚ÄúCrear‚Äù.",
        helpTitle:"Ayuda r√°pida", help1:"Complet√° t√≠tulo, mensaje y fecha (m√≠nimo +30 s).",
        help2:"Guard√°. Copi√° el enlace o us√° el QR/WhatsApp.", help3:"Si pusiste PIN, compartilo por separado.",
        help4:'El enlace <span class="kbd">?capsule=ID</span> abre la vista con countdown.',
        close:"Cerrar", enterPIN:"Ingres√° PIN", open:"Ver contenido",
        t_okCopied:"Enlace copiado ‚úÖ", t_saved:"C√°psula creada. Enlace copiado ‚úÖ",
        t_needBasic:"Complet√° t√≠tulo, mensaje y fecha.", t_pinBad:"PIN: 4‚Äì6 d√≠gitos.",
        t_dateBad:"La fecha debe ser ‚â• 30s en el futuro.", t_defineDate:"Defin√≠ la fecha primero.",
        t_exported:"Backup exportado", t_imported:"Backup importado ‚úÖ", t_badfile:"Archivo inv√°lido",
        t_noCaps:"No hay c√°psulas.", t_loadedForEdit:"Cargada en formulario para editar",
        t_deleted:"Eliminada", t_needSave:"Guard√° la c√°psula primero", t_wrongPin:"PIN incorrecto",
      },
      en: { brandA:"Time", brandB:"Capsule", themeAuto:"Auto", themeLight:"Light", themeDark:"Dark",
        navCreate:"Create", navMine:"My capsules", navHelp:"Help",
        heroBadge:"Futuristic ‚Ä¢ Production-ready (frontend)", heroTitle:"Save today. Unlock tomorrow.",
        heroDesc:"Create capsules with <b>title</b>, <b>message</b>, <b>open date</b>, <b>optional PIN</b> and <b>links</b>. Share via <b>link</b>, <b>QR</b> or <b>WhatsApp</b>. Unlock with animation & confetti.",
        heroDemo:"Demo countdown", ctaCreate:"Create capsule", ctaMine:"See my capsules",
        createTitle:"Create new capsule", export:"Export", import:"Import",
        fTitle:"Title *", fMsg:"Message *", fDate:"Date & time *", fPIN:"PIN (optional)",
        fLinks:"Attachments (links, optional)", fLinksHint:"Drive / YouTube / S3 / Dropbox.",
        btnSave:"Save capsule", btnPreview:"Preview", req:"* Required fields.",
        share:"Share", shareQR:"QR of the link", shareLink:"Shareable link",
        copy:"Copy", waMsg:"Message (for WhatsApp)", waSend:"Send via WhatsApp",
        waHint:"Opens WhatsApp with text + link.", waQR:"WhatsApp QR (message + link)",
        waQRHint:"Scanning opens WhatsApp with your message and link.",
        calendar:"Schedule open", dlIcs:"Download .ics", icsHint:"For Google/Apple Calendar.",
        mineTitle:"My capsules", localHint:"Local storage (no login). Export/Import from ‚ÄúCreate‚Äù.",
        helpTitle:"Quick help", help1:"Fill title, message and date (at least +30s).",
        help2:"Save. Copy the link or use QR/WhatsApp.", help3:"If you set a PIN, share it separately.",
        help4:'The link <span class="kbd">?capsule=ID</span> opens the countdown view.',
        close:"Close", enterPIN:"Enter PIN", open:"View content",
        t_okCopied:"Link copied ‚úÖ", t_saved:"Capsule created. Link copied ‚úÖ",
        t_needBasic:"Fill title, message and date.", t_pinBad:"PIN: 4‚Äì6 digits.",
        t_dateBad:"Date must be ‚â• 30s in the future.", t_defineDate:"Set the date first.",
        t_exported:"Backup exported", t_imported:"Backup imported ‚úÖ", t_badfile:"Invalid file",
        t_noCaps:"No capsules.", t_loadedForEdit:"Loaded into form to edit",
        t_deleted:"Deleted", t_needSave:"Save the capsule first", t_wrongPin:"Wrong PIN",
      }
    };

    // === Preferencias persistentes ===
    let lang = (localStorage.getItem("cvf_lang") || "").trim();
    if (!lang) lang = (navigator.language||"es").startsWith("en") ? "en" : "es";
    let theme = localStorage.getItem("cvf_theme") || "auto";
    document.documentElement.setAttribute("data-theme", theme);
    document.documentElement.lang = lang;
    $("langSel").value = lang; $("themeSel").value = theme;

    function i18nApply(){
      const pack = I18N[lang];
      els("[data-i18n]").forEach(n=>{
        const key = n.getAttribute("data-i18n");
        if (!pack[key]) return;
        if (n.tagName === "INPUT" || n.tagName === "TEXTAREA" || n.tagName==="SELECT") {
          if (n.placeholder) n.placeholder = pack[key];
        } else n.innerHTML = pack[key];
      });
      if ($("capTitle")) $("capTitle").placeholder = lang==="en" ? "e.g., Letter to future me" : "Ej: Carta al yo del futuro";
      if ($("capMessage")) $("capMessage").placeholder = lang==="en" ? "Write your message..." : "Escribe tu mensaje (texto).";
      if ($("capLinks")) $("capLinks").placeholder = lang==="en" ? "URL 1, URL 2, ..." : "URL 1, URL 2, ...";
      if ($("shareMsg") && !$("shareMsg").value) $("shareMsg").placeholder = lang==="en" ? "Here‚Äôs a capsule to open on its date ‚ú®" : "Te dejo esta c√°psula para abrir en la fecha ‚ú®";
    }
    i18nApply();

    // === URL params: lang/theme/auto ===
    (function applyLangFromQuery(){
      const qp = new URLSearchParams(location.search);
      const qlang = qp.get("lang");
      if (qlang && (qlang === "en" || qlang === "es")) {
        localStorage.setItem("cvf_lang", qlang);
        lang = qlang; document.documentElement.lang = lang; $("langSel").value = lang; i18nApply();
      }
    })();
    (function applyThemeFromQuery(){
      const qp = new URLSearchParams(location.search);
      const qtheme = qp.get("theme");
      if (qtheme && ["dark","light","auto"].includes(qtheme)) {
        localStorage.setItem("cvf_theme", qtheme);
        theme = qtheme; document.documentElement.setAttribute("data-theme", theme); $("themeSel").value = theme;
      }
    })();

    $("langSel").onchange = ()=>{ lang = $("langSel").value; localStorage.setItem("cvf_lang", lang); document.documentElement.lang = lang; i18nApply(); };
    $("themeSel").onchange = ()=>{ theme = $("themeSel").value; localStorage.setItem("cvf_theme", theme); document.documentElement.setAttribute("data-theme", theme); };

    // === Toasts ===
    const T = (k)=> I18N[lang][k] || k;
    function toast(msg, ok=true){
      const box = $("toasts");
      const div = document.createElement("div");
      div.className = "glass card px-4 py-3 border " + (ok ? "border-emerald-400/40" : "border-rose-400/40");
      div.innerHTML = `<div class="text-sm ${ok?"text-emerald-200":"text-rose-200"}">${msg}</div>`;
      box.appendChild(div); setTimeout(()=>div.remove(), 2600);
    }

    // === Hero demo ===
    const hero = $("cofreHero");
    let demoEnd = Date.now()+75*1000;
    setInterval(()=>{
      const d = Math.max(0, demoEnd - Date.now());
      const s = Math.floor(d/1000);
      const h = String(Math.floor(s/3600)).padStart(2,'0');
      const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      $("countHero").textContent = `${h}:${m}:${ss}`;
      if(d<=0) hero.classList.add("open");
    }, 1000);

    // === Utils ===
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function fmt(ts){ return new Date(ts).toLocaleString(lang==="en"?"en-US":"es-AR"); }
    function linkFor(id){ const u = new URL(location.href); u.search=""; u.hash=""; return `${u.toString()}?capsule=${encodeURIComponent(id)}`; }
    function waLink(id, msg){ const text = (msg || (lang==="en"?"Here‚Äôs a capsule to open on its date ‚ú®":"Te dejo esta c√°psula para abrir en la fecha ‚ú®")) + " " + linkFor(id); return "https://wa.me/?text=" + encodeURIComponent(text); }
    function parseDTLocal(v){ return new Date(v).getTime(); }
    function toDTLocalValue(ts){ const d = new Date(ts); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16); }

    // === Firebase upload helper ===
    async function uploadToStorage(file){
      if(!window.storage || !file) return null;
      // l√≠mite ejemplo 200MB:
      // if (file.size > 200*1024*1024) throw new Error("Max 200MB");
      const id = Math.random().toString(36).slice(2) + Date.now().toString(36);
      const path = `capsulas/${id}-${file.name.replace(/\s+/g,'_')}`;
      const ref = storage.ref().child(path);
      await ref.put(file, { contentType: file.type });
      const url = await ref.getDownloadURL();
      return url;
    }

    // === State ===
    const state = { items: [] };
    function load(){ try{ state.items = JSON.parse(localStorage.getItem("cvf_capsules")||"[]"); }catch{ state.items=[]; } }
    function save(){ localStorage.setItem("cvf_capsules", JSON.stringify(state.items)); }

    // === Share helpers ===
    function setQR(id="DEMO"){
      const node = $("qrPreview"); if(!node) return;
      node.innerHTML="";
      const text = id==="DEMO" ? location.href.split('#')[0] : linkFor(id);
      new QRCode(node,{ text, width:160, height:160, correctLevel: QRCode.CorrectLevel.H });
    }
    function setShareUI(id){
      const input=$("shareLink"), copyBtn=$("copyLinkBtn"), msgBox=$("shareMsg"), waBtn=$("waBtn"), waQr=$("waQr");
      const url = id ? linkFor(id) : "";
      if(input) input.value = url;
      if(msgBox && !msgBox.value) msgBox.value = lang==="en" ? "Here‚Äôs a capsule to open on its date ‚ú®" : "Te dejo esta c√°psula para abrir en la fecha ‚ú®";
      if(copyBtn) copyBtn.onclick = async ()=>{ if(!url) return toast(T("t_needSave"), false); try{ await navigator.clipboard.writeText(url); toast(T("t_okCopied")); }catch{ prompt("Copy manually:", url); } };
      if(waBtn) waBtn.onclick = ()=>{ if(!id) return toast(T("t_needSave"), false); location.href = waLink(id, msgBox?msgBox.value:""); };
      if(waQr){ waQr.innerHTML=""; if(id){ new QRCode(waQr,{ text: waLink(id, msgBox?msgBox.value:""), width:160, height:160, correctLevel:QRCode.CorrectLevel.H });
        if(msgBox){ msgBox.addEventListener("input", ()=>{ waQr.innerHTML=""; new QRCode(waQr,{ text: waLink(id, msgBox.value), width:160, height:160, correctLevel:QRCode.CorrectLevel.H }); }); } } }
    }

    // === Defaults create ===
    function defaultsForCreate(){ const dt = new Date(Date.now()+60000); $("capOpen").value = toDTLocalValue(dt); setQR(); setShareUI(null); }

    // === Create / Save ===
    $("btnCreate").onclick = async ()=>{
      const title = $("capTitle").value.trim();
      const message = $("capMessage").value.trim();
      const openStr = $("capOpen").value;
      const pin = $("capPIN").value.trim();
      const linksManual = ($("capLinks").value||"").split(",").map(s=>s.trim()).filter(Boolean);
      if(!title || !message || !openStr) return toast(T("t_needBasic"), false);
      if(pin && (pin.length<4 || pin.length>6 || !/^\d+$/.test(pin))) return toast(T("t_pinBad"), false);
      const openAt = parseDTLocal(openStr);
      if(!openAt || openAt < Date.now()+30*1000) return toast(T("t_dateBad"), false);

      // archivo opcional ‚Üí subir a Firebase
      const file = document.getElementById("capFile")?.files?.[0];
      let uploadedURL = null;
      if (file) {
        toast(lang==="en"?"Uploading file‚Ä¶":"Subiendo archivo‚Ä¶");
        try {
          uploadedURL = await uploadToStorage(file);
          if (uploadedURL) toast(lang==="en"?"Upload complete":"Subida completa");
        } catch(e) {
          console.error(e);
          toast(lang==="en"?"Upload failed":"Fall√≥ la subida", false);
        }
      }
      const links = uploadedURL ? [uploadedURL, ...linksManual] : linksManual;

      const id = uid();
      const capsule = { id, title, message, openAt, pin: pin||"", links, createdAt: Date.now(), privacy: pin? "private":"public" };
      state.items.unshift(capsule); save();

      setQR(id); setShareUI(id);
      try{ await navigator.clipboard.writeText(linkFor(id)); }catch{}
      toast(T("t_saved"));
      $("capTitle").value=""; $("capMessage").value=""; $("capLinks").value=""; $("capPIN").value=""; if ($("capFile")) $("capFile").value="";
      renderList();
    };

    $("btnPreview").onclick = ()=>{
      const c = {
        id:"PREVIEW",
        title:$("capTitle").value.trim()|| (lang==="en"?"Capsule":"C√°psula"),
        message:$("capMessage").value.trim()|| (lang==="en"?"Sample message.":"Mensaje de ejemplo."),
        openAt: parseDTLocal($("capOpen").value)||Date.now()+60000,
        links: ($("capLinks").value||"").split(",").map(s=>s.trim()).filter(Boolean),
        pin: $("capPIN").value.trim(),
        privacy: $("capPIN").value.trim()? "private":"public"
      };
      openViewer(c);
    };

    $("btnICS").onclick = ()=>{
      const title = $("capTitle").value.trim() || (lang==="en"?"Capsule opening":"Apertura de c√°psula");
      const openStr = $("capOpen").value; if(!openStr) return toast(T("t_defineDate"), false);
      const dt = new Date(openStr);
      const dtUTC = dt.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CapsulaVolverAlFuturo//ES
BEGIN:VEVENT
UID:${uid()}@cvf
DTSTAMP:${dtUTC}
DTSTART:${dtUTC}
SUMMARY:${title}
DESCRIPTION:${lang==="en"?"Reminder to open your capsule":"Recordatorio de apertura de c√°psula"}
END:VEVENT
END:VCALENDAR`;
      const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([ics],{type:"text/calendar"})); a.download="apertura_capsula.ics"; a.click();
      toast(".ics OK");
    };

    // Export / Import
    $("btnExport").onclick = ()=>{
      const a=document.createElement("a");
      a.href = URL.createObjectURL(new Blob([JSON.stringify(state.items,null,2)],{type:"application/json"}));
      a.download = "capsulas_backup.json"; a.click(); toast(T("t_exported"));
    };
    $("importFile").onchange = (e)=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload = ()=>{
        try{ const arr=JSON.parse(r.result||"[]"); if(!Array.isArray(arr)) throw new Error();
          const ids=new Set(state.items.map(x=>x.id));
          arr.forEach(x=>{ if(x && x.id && !ids.has(x.id)) state.items.push(x); });
          save(); toast(T("t_imported")); renderList();
        }catch{ toast(T("t_badfile"), false); }
      }; r.readAsText(f);
    };

    // === List ===
    $("search").addEventListener("input", renderList);
    function renderList(){
      const box = $("myList"); box.innerHTML="";
      const q = ($("search").value||"").toLowerCase();
      const items = state.items.filter(c => c.title.toLowerCase().includes(q));
      if(!items.length){ box.innerHTML=`<div class="p-4 glass card">${T("t_noCaps")}</div>`; return; }
      items.forEach(c=>{
        const url = linkFor(c.id);
        const card = document.createElement("div");
        card.className = "p-4 glass card border border-white/10";
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="pill">${c.pin? (lang==="en"?"Private":"Privada") : (lang==="en"?"Public":"P√∫blica")}</div>
            <div class="text-xs" style="color:var(--muted2)">${fmt(c.createdAt)}</div>
          </div>
          <div class="mt-1 text-lg font-bold" style="color:#22d3ee">${c.title}</div>
          <div class="text-sm" style="color:var(--muted)">${(c.message||"").replace(/\n/g," ").slice(0,180)}</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <a class="btn btn-primary" href="${url}">${lang==="en"?"Open / View":"Abrir / Vista"}</a>
            <button class="btn btn-ghost" data-act="copy">${T("copy")} ${lang==="en"?"link":""}</button>
            <button class="btn btn-ghost" data-act="wa">WhatsApp</button>
            <button class="btn btn-ghost" data-act="embed">Embed</button>
            <button class="btn btn-ghost" data-act="edit">${lang==="en"?"Edit":"Editar"}</button>
            <button class="btn btn-ghost" data-act="del">${lang==="en"?"Delete":"Eliminar"}</button>
          </div>
        `;
        card.querySelector('[data-act="copy"]').onclick = async ()=>{ try{ await navigator.clipboard.writeText(url); toast(T("t_okCopied")); }catch{ prompt("Copy manually:", url); } };
        card.querySelector('[data-act="wa"]').onclick = ()=>{ location.href = waLink(c.id, lang==="en"?"Here‚Äôs a capsule to open on its date ‚ú®":"Te dejo esta c√°psula para abrir en la fecha ‚ú®"); };
        card.querySelector('[data-act="embed"]').onclick = ()=>{
          const code = `<iframe src="${location.origin+location.pathname}?capsule=${c.id}" width="100%" height="520" frameborder="0"></iframe>`;
          navigator.clipboard?.writeText(code); toast("Embed copiado");
        };
        card.querySelector('[data-act="edit"]').onclick = ()=>{
          $("capTitle").value=c.title; $("capMessage").value=c.message;
          $("capOpen").value=toDTLocalValue(c.openAt); $("capPIN").value=c.pin||"";
          $("capLinks").value=(c.links||[]).join(", ");
          toast(T("t_loadedForEdit")); location.hash="#crear";
        };
        card.querySelector('[data-act="del"]').onclick = ()=>{
          if(confirm(lang==="en"?"Delete this capsule?":"¬øEliminar esta c√°psula?")){
            const idx = state.items.findIndex(x=>x.id===c.id);
            if(idx>=0){ state.items.splice(idx,1); save(); toast(T("t_deleted")); renderList(); }
          }
        };
        box.appendChild(card);
      });
    }

    // === Viewer ===
    function openViewer(c){
      $("modal").classList.remove("hidden");
      $("mTitle").textContent = c.title|| (lang==="en"?"Capsule":"C√°psula");
      $("mPrivacy").textContent = c.pin? (lang==="en"?"Private":"Privada") : (lang==="en"?"Public":"P√∫blica");
      $("mMessage").textContent = c.message||"";
      $("mLinks").innerHTML = (c.links||[]).map(u=>`<div><a class="underline" style="color:#22d3ee" target="_blank" href="${u}">${lang==="en"?"Attachment":"Adjunto"}</a></div>`).join("");
      $("mPINwrap").classList.toggle("hidden", !c.pin);

      function tick(){
        const d = Math.max(0, c.openAt - Date.now());
        const s = Math.floor(d/1000);
        const h = String(Math.floor(s/3600)).padStart(2,'0');
        const m = String(Math.floor((s%3600)/60)).padStart(2,'0');
        const ss = String(s%60).padStart(2,'0');
        $("mCountdown").textContent = d>0?`${h}:${m}:${ss}`:"00:00:00";
        if(d<=0){ $("mChest").classList.add("open"); $("mOpen").classList.remove("hidden"); clearInterval(tmr); }
      }
      const tmr=setInterval(tick,1000); tick();

      $("mOpen").onclick = ()=>{
        if(c.pin){
          const p = $("mPIN").value.trim();
          if(!p || p!==c.pin){ toast(T("t_wrongPin"), false); return; }
        }
        $("mContent").classList.remove("hidden");
        confetti({ particleCount: 240, spread: 70, origin: { y: 0.6 } });
      };
      $("mClose").onclick = ()=>{ $("modal").classList.add("hidden"); };
    }

    // Deep link ?capsule=ID (&auto=open)
    function checkDeepLink(){
      const params = new URLSearchParams(location.search);
      const id = params.get("capsule");
      if(!id) return;
      const c = state.items.find(x=>x.id===id);
      if(!c){ toast(lang==="en"?"Capsule not found on this device":"C√°psula no encontrada en este dispositivo", false); return; }
      openViewer(c);
      if (params.get("auto") === "open") {
        const tryOpen = setInterval(()=>{
          const btn = document.getElementById("mOpen");
          if (btn && !btn.classList.contains("hidden")) { btn.click(); clearInterval(tryOpen); }
        }, 500);
        setTimeout(()=>clearInterval(tryOpen), 20000);
      }
    }

    // Routing
    function defaults(){ const dt = new Date(Date.now()+60000); $("capOpen").value = toDTLocalValue(dt); setQR(); setShareUI(null); }
    function route(){ if(location.hash==="#mis") renderList(); else { defaults(); } }
    window.addEventListener("hashchange", route);

    // Init
    (function init(){
      load(); route(); checkDeepLink();
    })();

  })();
  </script>
</body>
</html>
