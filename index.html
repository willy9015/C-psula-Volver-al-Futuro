<!doctype html>
<html lang="es" data-theme="auto">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>C√°psula Volver al Futuro ‚Äî Futurista PRO</title>
  <meta name="theme-color" content="#0ea5e9">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#0f172a; --fg:#e5e7eb; --muted:#94a3b8;
      --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.02); --border:rgba(255,255,255,.14);
      --glow1:#22d3ee; --glow2:#a78bfa; --accent:#22d3ee;
      --bg-photo:url('grok_image_qtfpp7.jpg');
    }
    [data-theme="light"]{
      --bg1:#eef2f7; --bg2:#e7ecf5; --fg:#0f172a; --muted:#475569;
      --panel:#ffffffE6; --panel2:#ffffffF8; --border:rgba(0,0,0,.12);
      --glow1:#0ea5e9; --glow2:#6366f1; --accent:#0ea5e9;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--fg);
      background: linear-gradient(135deg,var(--bg1),var(--bg2)); position:relative; overflow-x:hidden;
    }
    /* Fondo con tu imagen difuminada */
    body::before{
      content:""; position:fixed; inset:0; z-index:-2;
      background-image:var(--bg-photo); background-size:180% auto; background-repeat:no-repeat; background-position:20% 10%;
      filter:blur(12px) saturate(1.1) brightness(0.55); transform:scale(1.05);
    }
    [data-theme="light"] body::before{ filter: blur(8px) saturate(1.05) brightness(0.94); }
    body::after{ content:""; position:fixed; inset:0; z-index:-1;
      background:radial-gradient(60% 60% at 15% 10%,rgba(0,0,0,.25),rgba(0,0,0,.6)); }
    [data-theme="light"] body::after{
      background:radial-gradient(60% 60% at 15% 10%,rgba(255,255,255,.25),rgba(255,255,255,.7));
    }

    .glass{background:linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); backdrop-filter:blur(10px)}
    .card{border-radius:1.2rem; box-shadow:0 16px 40px rgba(0,0,0,.18)}
    .btn{border-radius:.9rem; padding:.7rem 1rem; border:1px solid var(--border); transition:transform .08s ease}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn-primary{background:linear-gradient(90deg,var(--glow1),var(--glow2)); color:#0b1220; font-weight:800}
    .input,.textarea,select{width:100%; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:.9rem; padding:.8rem; color:var(--fg)}
    [data-theme="light"] .input,[data-theme="light"] .textarea,[data-theme="light"] select{ background:#fff; color:#0f172a }
    .pill{font-size:.72rem; background:rgba(255,255,255,.06); color:var(--muted); padding:.25rem .6rem; border-radius:999px; border:1px solid var(--border)}
    .toast{position:fixed; bottom:18px; right:18px; z-index:9999; display:grid; gap:8px}
    .hidden{display:none}

    /* Cofre 3D simple */
    .cofre{width:280px;height:165px;position:relative;margin:0 auto;filter:drop-shadow(0 10px 25px rgba(34,211,238,.25))}
    .cofre .base{position:absolute;inset:auto 0 0 0;height:70%;background:linear-gradient(180deg,#8b5e34,#b08968);border-radius:0 0 16px 16px;box-shadow:inset 0 10px 0 rgba(0,0,0,.25)}
    .cofre .tapa{position:absolute;inset:0 0 auto 0;height:60%;background:linear-gradient(180deg,#deb887,#a67c52);border-radius:16px 16px 10px 10px;transform-origin:top center;transition:transform .9s cubic-bezier(.2,.8,.2,1);box-shadow:inset 0 -10px 0 rgba(0,0,0,.25)}
    .cofre.open .tapa{transform:rotateX(72deg)}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="sticky top-0 z-40 backdrop-blur border-b" style="border-color:var(--border); background:linear-gradient(180deg,rgba(11,18,32,.8),rgba(11,18,32,.35))">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="#crear" class="flex items-center gap-3">
        <img src="grok_image_qtfpp7.jpg" alt="Logo" class="w-9 h-9 rounded-full object-cover border" style="border-color:var(--border)">
        <span class="font-extrabold text-xl">C√°psula Volver al Futuro</span>
      </a>
      <div class="flex items-center gap-2">
        <select id="langSel" class="input !py-2 !px-3" style="width:auto"><option value="es">ES</option><option value="en">EN</option></select>
        <select id="themeSel" class="input !py-2 !px-3" style="width:auto"><option value="auto">Auto</option><option value="light">Claro</option><option value="dark">Oscuro</option></select>
        <a href="#crear" class="btn btn-primary">Crear</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="max-w-6xl mx-auto p-4 md:p-8 grid md:grid-cols-2 gap-6 items-center">
    <div class="glass card p-6 md:p-8">
      <div class="pill mb-2">E2EE ‚Ä¢ QR ‚Ä¢ WhatsApp ‚Ä¢ Telegram ‚Ä¢ Geo-Unlock</div>
      <h1 class="text-3xl md:text-4xl font-extrabold mb-2" data-i18n="title">Guarda hoy. Descubre ma√±ana.</h1>
      <p class="opacity-90" data-i18n="subtitle">C√°psulas con cifrado de extremo a extremo, apertura por fecha y (opcional) ubicaci√≥n. Comparte por enlace, QR, WhatsApp o Telegram.</p>
      <div class="mt-4 rounded-2xl overflow-hidden border" style="border-color:var(--border)">
        <img src="grok_image_qtfpp7.jpg" alt="Key / fondo" class="w-full h-56 md:h-72 object-cover">
      </div>
    </div>
    <div class="glass card p-6 md:p-8">
      <h3 class="font-extrabold mb-3 text-cyan-200">Ideas virales (1-tap)</h3>
      <div class="grid grid-cols-2 gap-3">
        <button class="btn" data-preset="birthday">üéÇ Cumple programado</button>
        <button class="btn" data-preset="premiere">üé¨ Estreno YouTube</button>
        <button class="btn" data-preset="course">üìö Curso drip</button>
        <button class="btn" data-preset="gift">üéÅ Regalo del creador</button>
      </div>
      <div class="mt-6 text-center">
        <div id="countHero" class="text-4xl font-extrabold text-cyan-200">00:00:00</div>
        <div class="text-xs opacity-70">Demo de cuenta regresiva</div>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-4 md:p-8 grid gap-6">
    <!-- Crear -->
    <section id="crear" class="glass card p-6 md:p-8">
      <h2 class="text-2xl font-extrabold mb-4">Crear nueva c√°psula</h2>
      <div class="grid md:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div><label class="text-sm opacity-80">T√≠tulo *</label><input id="capTitle" class="input" placeholder="Ej: Carta al yo del futuro"></div>
          <div><label class="text-sm opacity-80">Mensaje *</label><textarea id="capMessage" class="textarea h-40" placeholder="Escribe tu mensaje"></textarea></div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm opacity-80">Fecha y hora *</label><input id="capOpen" type="datetime-local" class="input"></div>
            <div><label class="text-sm opacity-80">PIN (si eleg√≠s Modo PIN)</label><input id="capPIN" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="4‚Äì6"></div>
          </div>

          <!-- Seguridad -->
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="text-sm opacity-80">Seguridad</label>
              <select id="secMode" class="input">
                <option value="link">Link secreto (clave en #k=)</option>
                <option value="pin">PIN (deriva la clave del PIN)</option>
              </select>
            </div>
            <div>
              <label class="text-sm opacity-80">Geo-unlock (opcional)</label>
              <div class="flex gap-2">
                <input id="geoRadius" class="input" inputmode="numeric" placeholder="Radio en metros">
                <button id="geoMark" class="btn">Marcar ubicaci√≥n</button>
              </div>
              <div id="geoHint" class="text-xs opacity-70 mt-1"></div>
            </div>
          </div>

          <!-- Adjuntos por URL -->
          <div>
            <label class="text-sm opacity-80">Adjuntos por URL (YouTube/Drive/Imagen/Video)</label>
            <input id="capLinks" class="input" placeholder="URL 1, URL 2, ...">
          </div>

          <div class="flex gap-3 pt-2">
            <button id="btnCreate" class="btn btn-primary">Guardar c√°psula</button>
            <button id="btnPreview" class="btn">Previsualizar</button>
          </div>
          <p class="text-xs opacity-70">* Campos obligatorios. Sin backend: los datos viajan en el enlace cifrados.</p>
        </div>

        <div class="space-y-4">
          <div class="p-4 glass card">
            <h3 class="font-extrabold mb-3 text-cyan-200">Compartir</h3>
            <div>
              <div class="text-sm opacity-80 mb-1">QR del enlace</div>
              <div id="qrPreview" class="flex items-center justify-center p-4 rounded-xl border" style="background:var(--panel);border-color:var(--border)"></div>
            </div>
            <div class="mt-3">
              <label class="text-sm opacity-80 mb-1">Enlace</label>
              <div class="flex gap-2">
                <input id="shareLink" class="input flex-1" readonly placeholder="Se completa al guardar">
                <button id="copyLinkBtn" class="btn">Copiar</button>
              </div>
            </div>
            <div class="mt-3 flex gap-2">
              <button id="waBtn" class="btn btn-primary">WhatsApp</button>
              <button id="tgBtn" class="btn">Telegram</button>
              <button id="icsBtn" class="btn">Descargar .ics</button>
            </div>
          </div>

          <!-- Series (curso drip) -->
          <div class="p-4 glass card">
            <h3 class="font-extrabold mb-3 text-cyan-200">Creador de series</h3>
            <div class="grid grid-cols-3 gap-3">
              <input id="seriesN" class="input" placeholder="# c√°psulas" inputmode="numeric">
              <input id="seriesStep" class="input" placeholder="Cada X d√≠as" inputmode="numeric">
              <button id="seriesBtn" class="btn">Generar</button>
            </div>
            <p class="text-xs opacity-70 mt-1">Genera N c√°psulas desde la fecha, separadas por X d√≠as.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Mis c√°psulas + ranking -->
    <section id="mis" class="glass card p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-extrabold">Mis c√°psulas</h2>
        <input id="search" class="input max-w-xs" placeholder="Buscar por t√≠tulo‚Ä¶">
      </div>
      <div id="myList" class="grid md:grid-cols-2 gap-4"></div>

      <div class="mt-6">
        <h3 class="font-extrabold text-cyan-200 mb-2">Tendencias (local)</h3>
        <div id="topList" class="grid md:grid-cols-3 gap-3"></div>
      </div>
    </section>

    <!-- Feedback app -->
    <section class="glass card p-6 md:p-8">
      <h3 class="font-extrabold mb-2">Califica la app</h3>
      <div class="flex items-center gap-2">
        <select id="appRate" class="input" style="width:auto">
          <option value="5">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option><option value="4">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option>
          <option value="3">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</option><option value="2">‚≠êÔ∏è‚≠êÔ∏è</option><option value="1">‚≠êÔ∏è</option>
        </select>
        <input id="appComment" class="input flex-1" placeholder="Tu comentario">
        <button id="appSend" class="btn btn-primary">Enviar</button>
      </div>
      <div id="appWall" class="grid md:grid-cols-2 gap-3 mt-3"></div>
    </section>
  </main>

  <!-- Modal Viewer -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 p-4">
    <div class="max-w-2xl mx-auto glass card p-6 border" style="border-color:var(--border)">
      <div class="flex items-center justify-between">
        <div id="mPrivacy" class="pill">E2EE</div>
        <button id="mClose" class="btn" aria-label="Cerrar">Cerrar</button>
      </div>

      <div class="flex items-center gap-3 mt-2">
        <img src="grok_image_qtfpp7.jpg" alt="Logo" class="w-8 h-8 rounded-full object-cover border" style="border-color:var(--border)">
        <div id="mTitle" class="text-2xl font-extrabold text-cyan-200">T√≠tulo</div>
      </div>

      <!-- Cofre (desaparece al abrir) -->
      <div id="mChestWrap" class="flex items-center justify-center my-5">
        <div id="mChest" class="cofre"><div class="tapa"></div><div class="base"></div></div>
      </div>

      <div id="mCountdown" class="text-3xl font-extrabold text-cyan-200 text-center mb-3">00:00:00</div>

      <!-- PIN si modo PIN -->
      <div id="mPINwrap" class="hidden mb-3">
        <label class="text-sm opacity-80">Ingres√° PIN</label>
        <input id="mPIN" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="4‚Äì6">
      </div>

      <!-- Check geolocalizaci√≥n si aplica -->
      <div id="mGEOWrap" class="hidden mb-3 text-sm opacity-90">
        Esta c√°psula requiere estar en la ubicaci√≥n configurada. <button id="geoCheck" class="btn">Verificar ubicaci√≥n</button>
        <div id="geoResult" class="text-xs opacity-70 mt-1"></div>
      </div>

      <!-- Contenido grande -->
      <div id="mContent" class="hidden space-y-3">
        <div class="flex items-center justify-between">
          <button id="likeBtn" class="btn">üíú <span id="likeCount">0</span></button>
          <div class="text-xs opacity-70">Aperturas: <span id="openCount">0</span></div>
        </div>
        <div id="mMessage" class="p-4 rounded-xl border text-lg leading-relaxed" style="background:var(--panel);border-color:var(--border)">...</div>
        <div id="mLinks" class="grid gap-3"></div>

        <!-- Comentarios locales -->
        <div>
          <h4 class="font-bold mb-2">Comentarios</h4>
          <div id="cList" class="grid gap-2 mb-2"></div>
          <div class="flex gap-2">
            <input id="cName" class="input" placeholder="Tu nombre">
            <input id="cText" class="input flex-1" placeholder="Escribe un comentario‚Ä¶">
            <button id="cSend" class="btn">Enviar</button>
          </div>
          <div class="mt-3">
            <button id="certBtn" class="btn">Descargar certificado de apertura</button>
          </div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="mOpen" class="btn btn-primary hidden">Ver contenido</button>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toasts" class="toast"></div>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const els = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const LSKEY="cvf_capsules";

    // ===== i18n m√≠nimo
    const I18N = {
      es:{ title:"Guarda hoy. Descubre ma√±ana.", subtitle:"C√°psulas con cifrado de extremo a extremo, apertura por fecha y (opcional) ubicaci√≥n. Comparte por enlace, QR, WhatsApp o Telegram." },
      en:{ title:"Save today. Unlock tomorrow.", subtitle:"End-to-end encrypted capsules, time-locked and optionally geo-locked. Share via link, QR, WhatsApp or Telegram." }
    };
    function setLang(l){ localStorage.setItem("cvf_lang", l); const t=I18N[l]||I18N.es; els("[data-i18n]").forEach(n=>{ const k=n.getAttribute("data-i18n"); if(t[k]) n.textContent=t[k]; }); }
    const lang = localStorage.getItem("cvf_lang") || "es"; $("langSel").value = lang; setLang(lang);
    $("langSel").onchange=()=>setLang($("langSel").value);

    // ===== Tema
    const theme = localStorage.getItem("cvf_theme") || "auto";
    document.documentElement.setAttribute("data-theme", theme);
    $("themeSel").value = theme;
    $("themeSel").onchange = ()=>{ localStorage.setItem("cvf_theme", $("themeSel").value); document.documentElement.setAttribute("data-theme", $("themeSel").value); };

    // ===== Toast
    function toast(msg, ok=true){
      const box = $("toasts"); const div = document.createElement("div");
      div.className = "glass card px-4 py-3 border "+(ok?"border-emerald-400/40":"border-rose-400/40");
      div.innerHTML = `<div class="text-sm ${ok?"text-emerald-200":"text-rose-200"}">${msg}</div>`;
      box.appendChild(div); setTimeout(()=>div.remove(), 2600);
    }

    // ===== Util fechas
    function parseDTLocal(v){ return new Date(v).getTime(); }
    function toDTLocalValue(ts){ const d=new Date(ts); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16); }

    // ===== Hero demo
    let demoEnd = Date.now()+75*1000;
    setInterval(()=>{
      const d=Math.max(0, demoEnd-Date.now());
      const s=Math.floor(d/1000);
      const H=String(Math.floor(s/3600)).padStart(2,'0');
      const M=String(Math.floor((s%3600)/60)).padStart(2,'0');
      const S=String(s%60).padStart(2,'0');
      $("countHero").textContent = `${H}:${M}:${S}`;
    },1000);

    // ===== Crypt helpers (WebCrypto AES-GCM)
    const enc = new TextEncoder(); const dec = new TextDecoder();
    const b64 = {
      to(b){ return btoa(String.fromCharCode(...new Uint8Array(b))); },
      from(s){ return Uint8Array.from(atob(s), c=>c.charCodeAt(0)); }
    };
    async function aesImportRaw(keyBytes){ return await crypto.subtle.importKey("raw", keyBytes, "AES-GCM", false, ["encrypt","decrypt"]); }
    async function aesGenKey(){ const k = crypto.getRandomValues(new Uint8Array(32)); return {raw:k, crypto: await aesImportRaw(k)}; }
    async function deriveFromPIN(pin, salt){
      const base = await crypto.subtle.importKey("raw", enc.encode(pin), "PBKDF2", false, ["deriveBits","deriveKey"]);
      const k = await crypto.subtle.deriveKey({name:"PBKDF2", salt, iterations:100000, hash:"SHA-256"}, base, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);
      const raw = new Uint8Array(await crypto.subtle.exportKey("raw", k));
      return { raw, crypto: await aesImportRaw(raw) };
    }
    async function aesEncrypt(keyCrypto, msg){
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, keyCrypto, enc.encode(msg));
      return { iv, ct:new Uint8Array(ct) };
    }
    async function aesDecrypt(keyCrypto, iv, ct){
      const p = await crypto.subtle.decrypt({name:"AES-GCM", iv}, keyCrypto, ct);
      return dec.decode(p);
    }

    // ===== Clasificar & Embeds
    function classifyLink(u){
      try{
        const url=new URL(u), path=url.pathname.toLowerCase(), host=url.hostname.toLowerCase();
        if (host.includes("youtube.com") || host.includes("youtu.be")) return {type:"youtube", url:u};
        if (/\.(mp4|webm|ogv)(\?|#|$)/.test(path)) return {type:"video", url:u};
        if (/\.(mp3|m4a|ogg|wav)(\?|#|$)/.test(path)) return {type:"audio", url:u};
        if (/\.(png|jpg|jpeg|gif|webp|avif)(\?|#|$)/.test(path)) return {type:"image", url:u};
        if (host.includes("drive.google.com")) return {type:"gdrive", url:u};
        return {type:"link", url:u};
      }catch{ return {type:"link", url:u}; }
    }
    function renderEmbedHTML(item){
      const {type, url} = item;
      if (type==="youtube"){
        let vid=""; try{ const u=new URL(url); vid=u.hostname.includes("youtu.be")?u.pathname.slice(1):(u.searchParams.get("v")||""); }catch{}
        if (vid) return `<div class="rounded-xl overflow-hidden border" style="background:var(--panel);border-color:var(--border)"><iframe width="100%" height="360" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe></div>`;
      }
      if (type==="video") return `<video controls class="w-full rounded-xl border" style="background:var(--panel);border-color:var(--border)}"><source src="${url}"></video>`;
      if (type==="audio") return `<audio controls class="w-full"><source src="${url}"></audio>`;
      if (type==="image") return `<img src="${url}" alt="Adjunto" class="max-h-[420px] w-auto rounded-xl border" style="border-color:var(--border)"/>`;
      if (type==="gdrive"){
        let iframe=""; try{ const u=new URL(url); let id=""; const m=u.pathname.match(/\/file\/d\/([^/]+)/); if(m) id=m[1]; else id=u.searchParams.get("id")||""; if(id) iframe=`<iframe src="https://drive.google.com/file/d/${id}/preview" width="100%" height="360" allow="autoplay"></iframe>`; }catch{}
        return `<div class="space-y-2">${iframe?`<div class="rounded-xl overflow-hidden border" style="background:var(--panel);border-color:var(--border)">${iframe}</div>`:""}<a class="underline" style="color:var(--accent)" href="${url}" target="_blank">Ver en Drive</a></div>`;
      }
      return `<a class="underline" style="color:var(--accent)" target="_blank" href="${url}">${url}</a>`;
    }

    // ===== Local DB
    const state = { items: [] };
    function load(){ try{ state.items = JSON.parse(localStorage.getItem(LSKEY)||"[]"); }catch{ state.items=[]; } }
    function save(){ localStorage.setItem(LSKEY, JSON.stringify(state.items)); }

    // ===== QR/Compartir
    function setQR(nodeId, text){
      const node = $(nodeId); node.innerHTML="";
      new QRCode(node,{ text, width:160, height:160, correctLevel:QRCode.CorrectLevel.H });
    }

    // ===== Link portable
    function makeLinkPayload(obj){
      const json = JSON.stringify(obj);
      return btoa(unescape(encodeURIComponent(json))); // base64 en query
    }
    function parseLinkPayload(b64){
      return JSON.parse(decodeURIComponent(escape(atob(b64))));
    }

    // ===== Crear c√°psula (con cifrado)
    async function createCapsule(){
      const title=$("capTitle").value.trim();
      const message=$("capMessage").value.trim();
      const openStr=$("capOpen").value;
      const pin=$("capPIN").value.trim();
      const secMode=$("secMode").value; // link | pin
      const links=($("capLinks").value||"").split(",").map(s=>s.trim()).filter(Boolean);
      const geoR = parseInt(($("geoRadius").value||"").trim(),10);
      if(!title||!message||!openStr) return toast("Complet√° t√≠tulo, mensaje y fecha.", false);
      if(secMode==="pin" && (!/^\d{4,6}$/.test(pin))) return toast("PIN: 4‚Äì6 d√≠gitos.", false);
      const openAt=parseDTLocal(openStr);
      if(!openAt || openAt < Date.now()+30*1000) return toast("La fecha debe ser ‚â• 30s en el futuro.", false);

      // crypto
      let meta = { id: uid(), title, openAt, mode:secMode, links, createdAt: Date.now() };
      let salt=null, keyRaw=null, keyCrypto=null, iv, ct;

      if (secMode==="link"){
        const k = await aesGenKey(); keyRaw=k.raw; keyCrypto=k.crypto;
        const out = await aesEncrypt(keyCrypto, message); iv=out.iv; ct=out.ct;
      } else {
        salt = crypto.getRandomValues(new Uint8Array(16));
        const k = await deriveFromPIN(pin, salt); keyRaw=k.raw; keyCrypto=k.crypto;
        const out = await aesEncrypt(keyCrypto, message); iv=out.iv; ct=out.ct;
      }

      // geo
      if (geoPos && geoR>0){
        meta.geo = { lat: geoPos.lat, lon: geoPos.lon, r: geoR };
      }

      const payload = {
        ...meta,
        iv: b64.to(iv),
        salt: salt ? b64.to(salt) : null,
        ct: b64.to(ct)
      };
      const base = new URL(location.href); base.search=""; base.hash="";
      base.searchParams.set("capsule", meta.id);
      base.searchParams.set("data", makeLinkPayload(payload));
      if (secMode==="link"){
        // la clave solo en el fragment (no viaja en HTTP)
        base.hash = "k="+b64.to(keyRaw);
      }

      const url=base.toString();
      $("shareLink").value = url;
      setQR("qrPreview", url);
      $("copyLinkBtn").onclick=async()=>{ try{ await navigator.clipboard.writeText(url); toast("Enlace copiado ‚úÖ"); }catch{ prompt("Copi√° manualmente:", url); } };
      $("waBtn").onclick=()=>{ location.href=`https://wa.me/?text=${encodeURIComponent("Te dejo esta c√°psula ‚ú® "+url)}`; };
      $("tgBtn").onclick=()=>{ location.href=`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent("Te dejo esta c√°psula ‚ú®")}`; };
      $("icsBtn").onclick=()=>downloadICS(meta);

      // guardar listado local (no guarda el texto en claro)
      state.items.unshift({ ...meta, likes:0, opens:0 });
      save(); renderList(); toast("C√°psula creada. Enlace listo ‚úÖ");
      // limpiar form
      $("capTitle").value=""; $("capMessage").value=""; $("capPIN").value=""; $("capLinks").value="";
    }

    // ===== Geolocalizaci√≥n
    let geoPos=null;
    $("geoMark").onclick=()=>{
      const r = parseInt(($("geoRadius").value||"").trim(),10);
      if(!r){ toast("Indic√° un radio (m).", false); return; }
      if(!navigator.geolocation){ toast("Geolocalizaci√≥n no disponible", false); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        geoPos={ lat: pos.coords.latitude, lon: pos.coords.longitude };
        $("geoHint").textContent=`Fijado: ${geoPos.lat.toFixed(5)}, ${geoPos.lon.toFixed(5)} (¬±${r}m)`;
        toast("Ubicaci√≥n marcada ‚úÖ");
      }, ()=> toast("No se pudo obtener ubicaci√≥n", false), { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
    };
    function haversine(lat1,lon1,lat2,lon2){
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    // ===== Series (curso drip)
    $("seriesBtn").onclick=()=>{
      const n=parseInt(($("seriesN").value||"0"),10);
      const step=parseInt(($("seriesStep").value||"0"),10);
      const baseStr=$("capOpen").value;
      if(!n||!step||!baseStr) return toast("Complet√° cantidad, intervalo y fecha base.", false);
      const base=parseDTLocal(baseStr);
      for(let i=0;i<n;i++){
        const t = base + (i*step*24*60*60*1000);
        state.items.unshift({ id:uid(), title:`${$("capTitle").value.trim()||"Clase"} #${i+1}`, openAt:t, mode:$("secMode").value, links:[], createdAt:Date.now(), likes:0, opens:0 });
      }
      save(); renderList(); toast("Serie generada ‚úÖ");
    };

    // ===== Presets
    document.querySelectorAll('[data-preset]').forEach(b=>{
      b.onclick=()=>{
        const p=b.dataset.preset, now=Date.now();
        if(p==="birthday"){
          $("capTitle").value="Feliz cumple üéÇ (abre a las 00:00)";
          $("capMessage").value="¬°Feliz cumple! üí´ Te prepar√© este mensaje.";
          const d=new Date(now+24*60*60*1000); d.setHours(0,0,0,0);
          $("capOpen").value = toDTLocalValue(d.getTime());
          $("secMode").value="link";
        } else if(p==="premiere"){
          $("capTitle").value="Estreno del video üé¨";
          $("capMessage").value="¬°Gracias por activar la campanita! Abr√≠ durante el estreno.";
          $("capLinks").value="https://youtube.com/watch?v=VIDEO_ID";
          $("capOpen").value = toDTLocalValue(now+60*60*1000);
          $("secMode").value="link";
        } else if(p==="course"){
          $("capTitle").value="Curso drip ‚Äî Clase 1";
          $("capMessage").value="Bienvenido/a al curso. Ma√±ana llega la Clase 2 üòâ";
          $("capOpen").value = toDTLocalValue(now+5*60*1000);
          $("seriesN").value="5"; $("seriesStep").value="1";
          $("secMode").value="pin";
        } else if(p==="gift"){
          $("capTitle").value="Regalo del creador üéÅ";
          $("capMessage").value="Gracias por seguirme. Abr√≠ y reclam√° tu sorpresa.";
          $("capOpen").value = toDTLocalValue(now+2*60*60*1000);
          $("secMode").value="link";
        }
        toast("Preset cargado ‚úÖ");
      };
    });

    // ===== Listado + ranking
    $("search").addEventListener("input", renderList);
    function renderList(){
      const box=$("myList"); box.innerHTML="";
      const q=($("search").value||"").toLowerCase();
      const items=state.items.filter(c=> (c.title||"").toLowerCase().includes(q));
      if(!items.length){ box.innerHTML=`<div class="p-4 glass card">No hay c√°psulas.</div>`; $("topList").innerHTML=""; return; }
      items.forEach(c=>{
        const card=document.createElement("div"); card.className="p-4 glass card border"; card.style.borderColor="var(--border)";
        const eta = c.openAt > Date.now() ? new Date(c.openAt).toLocaleString() : "¬°Lista!";
        card.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="pill">E2EE ‚Ä¢ ${c.mode==="pin"?"PIN":"Link secreto"}</div>
            <div class="text-xs" style="color:var(--muted)">${new Date(c.createdAt).toLocaleString()}</div>
          </div>
          <div class="mt-1 text-lg font-bold" style="color:var(--accent)">${c.title}</div>
          <div class="text-sm" style="color:var(--muted)">Se abre: ${eta}</div>
          <div class="mt-2 text-xs" style="color:var(--muted)">Likes: ${c.likes||0} ¬∑ Aperturas: ${c.opens||0}</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="btn btn-primary" data-act="view">Abrir / Vista</button>
            <button class="btn" data-act="copy">Copiar link</button>
            <button class="btn" data-act="wa">WhatsApp</button>
            <button class="btn" data-act="tg">Telegram</button>
            <button class="btn" data-act="del">Eliminar</button>
          </div>`;
        card.querySelector('[data-act="view"]').onclick=()=>openViewerFromCard(c);
        card.querySelector('[data-act="copy"]').onclick=async()=>{
          const url = makeShareURLFromMeta(c);
          try{ await navigator.clipboard.writeText(url); toast("Enlace copiado ‚úÖ"); }catch{ prompt("Copi√° manualmente:", url); }
        };
        card.querySelector('[data-act="wa"]').onclick=()=>{ const url=makeShareURLFromMeta(c); location.href=`https://wa.me/?text=${encodeURIComponent("Te dejo esta c√°psula ‚ú® "+url)}`; };
        card.querySelector('[data-act="tg"]').onclick=()=>{ const url=makeShareURLFromMeta(c); location.href=`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent("Te dejo esta c√°psula ‚ú®")}`; };
        card.querySelector('[data-act="del"]').onclick=()=>{
          if(confirm("¬øEliminar esta c√°psula?")){ state.items = state.items.filter(x=>x.id!==c.id); save(); renderList(); toast("Eliminada"); }
        };
        box.appendChild(card);
      });
      // Top
      const top = [...state.items].sort((a,b)=>(b.likes||0)+(b.opens||0)-(a.likes||0)-(a.opens||0)).slice(0,6);
      $("topList").innerHTML = top.map(c=>`<div class="glass card p-3 border" style="border-color:var(--border)">
        <div class="text-sm font-bold" style="color:var(--accent)">${c.title}</div>
        <div class="text-xs" style="color:var(--muted)">Likes ${c.likes||0} ¬∑ Opens ${c.opens||0}</div>
        <button class="btn mt-2" onclick="location.href='${makeShareURLFromMeta(c)}'">Compartir</button>
      </div>`).join("");
    }

    // Construir link compartible desde meta (sin el mensaje, pero v√°lido si era de modo link? -> mostramos aviso)
    function makeShareURLFromMeta(meta){
      // Sin el texto cifrado no tiene contenido (porque el mensaje no se guarda local en claro).
      // Generamos un link informativo que apunta a esta misma p√°gina con s√≥lo el t√≠tulo, para que pida el original.
      const payload = { id:meta.id, title:meta.title, openAt:meta.openAt, mode:meta.mode, links:meta.links||[], iv:null, salt:null, ct:null, ghost:true };
      const base = new URL(location.href); base.search=""; base.hash="";
      base.searchParams.set("capsule", meta.id);
      base.searchParams.set("data", makeLinkPayload(payload));
      return base.toString();
    }

    // ===== Viewer (abrir desde card con datos locales -> s√≥lo meta; requiere link real para descifrar)
    function openViewerFromCard(meta){
      const p = new URLSearchParams(location.search);
      let data = p.get("data"); // si hay en URL actual, √∫salo
      if(!data){
        alert("Us√° el enlace generado al crear para abrir con contenido cifrado.\nDesde el listado local s√≥lo ves meta.");
        return;
      }
      openViewer(data, location.hash);
    }

    // ===== Viewer (desde deep link real)
    function openViewer(dataB64, hash){
      const payload = parseLinkPayload(dataB64);
      $("modal").classList.remove("hidden");
      $("mTitle").textContent=payload.title||"C√°psula";
      $("mPrivacy").textContent="E2EE ‚Ä¢ "+(payload.mode==="pin"?"PIN":"Link secreto");

      // countdown
      function tick(){
        const d=Math.max(0, (payload.openAt||0)-Date.now());
        const s=Math.floor(d/1000);
        const H=String(Math.floor(s/3600)).padStart(2,'0');
        const M=String(Math.floor((s%3600)/60)).padStart(2,'0');
        const S=String(s%60).padStart(2,'0');
        $("mCountdown").textContent=d>0?`${H}:${M}:${S}`:"00:00:00";
        if(d<=0){ $("mOpen").classList.remove("hidden"); clearInterval(tmr); }
      }
      const tmr=setInterval(tick,1000); tick();

      // geolock?
      let geoOK=true;
      if (payload.geo){
        $("mGEOWrap").classList.remove("hidden");
        $("geoCheck").onclick=()=>{
          if(!navigator.geolocation){ $("geoResult").textContent="Geolocalizaci√≥n no disponible"; geoOK=false; return; }
          navigator.geolocation.getCurrentPosition(pos=>{
            const dist = Math.round(haversine(payload.geo.lat, payload.geo.lon, pos.coords.latitude, pos.coords.longitude));
            geoOK = dist <= (payload.geo.r||0);
            $("geoResult").textContent = geoOK ? `OK, est√°s dentro (${dist} m)` : `Fuera de radio (${dist} m)`;
          }, ()=>{ $("geoResult").textContent="No se pudo obtener ubicaci√≥n"; geoOK=false; }, {enableHighAccuracy:true, timeout:8000});
        };
      }

      // PIN?
      $("mPINwrap").classList.toggle("hidden", payload.mode!=="pin");

      $("mOpen").onclick=async ()=>{
        if(!geoOK && payload.geo){ toast("Ten√©s que estar en la ubicaci√≥n.", false); return; }
        // Descifrar
        try{
          let keyCrypto=null;
          const iv = b64.from(payload.iv||"");
          const ct = b64.from(payload.ct||"");
          if(payload.mode==="link"){
            const h = new URLSearchParams((hash||"").replace(/^#/, ""));
            const k = h.get("k"); if(!k){ toast("Falta clave (#k) en el link", false); return; }
            const keyRaw = b64.from(k);
            keyCrypto = await aesImportRaw(keyRaw);
          } else {
            const pin = $("mPIN").value.trim();
            if(!/^\d{4,6}$/.test(pin)) return toast("PIN inv√°lido", false);
            const salt = b64.from(payload.salt||"");
            keyCrypto = (await deriveFromPIN(pin, salt)).crypto;
          }
          const msg = await aesDecrypt(keyCrypto, iv, ct);
          // Open UI
          $("mChestWrap").classList.add("hidden");
          $("mContent").classList.remove("hidden");
          $("mMessage").textContent = msg;
          $("mLinks").innerHTML = (payload.links||[]).map(u=>renderEmbedHTML(classifyLink(u))).join("");
          confetti({ particleCount:240, spread:70, origin:{ y:0.6 } });

          // m√©tricas locales
          incrOpen(payload.id);
          // likes
          $("likeCount").textContent = getLikes(payload.id);
          $("likeBtn").onclick=()=>{ const v=incrLike(payload.id); $("likeCount").textContent=v; };

          // comentarios
          renderComments(payload.id);
          $("cSend").onclick=()=>sendComment(payload.id);

          // certificado
          $("certBtn").onclick=()=>downloadCertificate(payload.title);
        }catch(e){
          console.error(e);
          toast("No se pudo descifrar. Verific√° clave/PIN.", false);
        }
      };

      $("mClose").onclick=()=>{ $("modal").classList.add("hidden"); };
    }

    // ===== Likes & opens
    function getItemMeta(id){ const a=JSON.parse(localStorage.getItem(LSKEY)||"[]"); return a.find(x=>x.id===id); }
    function writeItemMeta(m){ const a=JSON.parse(localStorage.getItem(LSKEY)||"[]"); const i=a.findIndex(x=>x.id===m.id); if(i>=0) a[i]=m; localStorage.setItem(LSKEY, JSON.stringify(a)); }
    function incrOpen(id){ const m=getItemMeta(id); if(!m) return 0; m.opens=(m.opens||0)+1; writeItemMeta(m); renderList(); return m.opens; }
    function getLikes(id){ const m=getItemMeta(id); return m? (m.likes||0):0; }
    function incrLike(id){ const m=getItemMeta(id); if(!m) return 0; m.likes=(m.likes||0)+1; writeItemMeta(m); renderList(); return m.likes; }

    // ===== Comentarios
    function commentsKey(id){ return "cvf_comments_"+id; }
    function renderComments(id){
      const arr = JSON.parse(localStorage.getItem(commentsKey(id))||"[]");
      $("cList").innerHTML = arr.map(x=>`<div class="glass card p-2 border" style="border-color:var(--border)"><b>${x.n||"An√≥nimo"}:</b> ${x.t}</div>`).join("");
    }
    function sendComment(id){
      const n=$("cName").value.trim(); const t=$("cText").value.trim(); if(!t) return;
      const arr = JSON.parse(localStorage.getItem(commentsKey(id))||"[]"); arr.push({n,t,ts:Date.now()});
      localStorage.setItem(commentsKey(id), JSON.stringify(arr)); $("cText").value=""; renderComments(id); toast("Comentario enviado ‚úÖ");
    }

    // ===== ICS
    function downloadICS(meta){
      const dt = new Date(meta.openAt).toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//CVF//ES
BEGIN:VEVENT
UID:${meta.id}
DTSTAMP:${dt}
DTSTART:${dt}
SUMMARY:${meta.title.replace(/[\n\r]/g," ")}
DESCRIPTION:Capsula programada
END:VEVENT
END:VCALENDAR`.trim();
      const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([ics],{type:"text/calendar"}));
      a.download=`capsula_${meta.id}.ics`; a.click();
    }

    // ===== Certificado PNG
    function downloadCertificate(title){
      const c=document.createElement("canvas"); c.width=1200; c.height=630; const ctx=c.getContext("2d");
      // fondo
      const g=ctx.createLinearGradient(0,0,c.width,c.height);
      g.addColorStop(0,"#0ea5e9"); g.addColorStop(1,"#6366f1"); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
      // marco
      ctx.strokeStyle="rgba(255,255,255,.6)"; ctx.lineWidth=8; ctx.strokeRect(24,24,c.width-48,c.height-48);
      ctx.fillStyle="#fff"; ctx.font="bold 56px Inter"; ctx.fillText("Certificado de apertura", 80, 150);
      ctx.font="28px Inter"; ctx.fillText("C√°psula:", 80, 220);
      wrapText(ctx, title, 200, 220, 980, 34);
      ctx.font="24px Inter"; ctx.fillText("Fecha:", 80, 300);
      ctx.fillText(new Date().toLocaleString(), 160, 300);
      ctx.font="24px Inter"; ctx.fillText("Emitido por C√°psula Volver al Futuro", 80, 360);
      const a=document.createElement("a"); a.href=c.toDataURL("image/png"); a.download="certificado_apertura.png"; a.click();
      function wrapText(ctx, text, x, y, maxW, lh){
        const words=text.split(" "); let line="";
        for(let n=0; n<words.length; n++){
          const test=line+words[n]+" "; const w=ctx.measureText(test).width;
          if(w>maxW && n>0){ ctx.fillText(line, x, y); line=words[n]+" "; y+=lh; } else line=test;
        }
        ctx.fillText(line, x, y);
      }
    }

    // ===== Deep link
    function checkDeepLink(){
      const p=new URLSearchParams(location.search);
      const data=p.get("data"); if(!data) return;
      openViewer(data, location.hash);
    }

    // ===== Feedback app
    $("appSend").onclick=()=>{
      const r=Number($("appRate").value), t=$("appComment").value.trim();
      const arr=JSON.parse(localStorage.getItem("cvf_app_feedback")||"[]"); arr.unshift({r,t,ts:Date.now()});
      localStorage.setItem("cvf_app_feedback", JSON.stringify(arr)); $("appComment").value="";
      renderAppWall(); toast("¬°Gracias por tu feedback! ‚úÖ");
    };
    function renderAppWall(){
      const arr=JSON.parse(localStorage.getItem("cvf_app_feedback")||"[]");
      $("appWall").innerHTML = arr.slice(0,10).map(x=>`<div class="glass card p-3 border" style="border-color:var(--border)">
        <div>${"‚≠êÔ∏è".repeat(x.r)}</div>
        <div class="text-sm mt-1">${x.t||""}</div>
        <div class="text-xs opacity-70 mt-1">${new Date(x.ts).toLocaleString()}</div>
      </div>`).join("");
    }

    // ===== Helpers
    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    // ===== Eventos UI
    $("btnCreate").onclick=()=>createCapsule();
    $("btnPreview").onclick=()=>{
      // Previsualiza sin cifrado real (s√≥lo UI)
      const meta={ id:"PREV", title:$("capTitle").value||"C√°psula", openAt:Date.now()+3000, mode:$("secMode").value, links:($("capLinks").value||"").split(",").map(s=>s.trim()).filter(Boolean) };
      const fake = makeLinkPayload({ ...meta, iv:"", salt:"", ct:"", ghost:true });
      openViewer(fake, "");
    };

    // Defaults
    (function init(){
      const dt = new Date(Date.now()+60000); $("capOpen").value = toDTLocalValue(dt.getTime());
      load(); renderList(); renderAppWall(); checkDeepLink();
    })();
  })();
  </script>
</body>
</html>
